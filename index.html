<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de Hipotecas - Corporación Calem</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>

/* Variables de color - Esquema naranja futurista */
:root {
    --primary-color: #FF6B00;
    --primary-dark: #E05600;
    --primary-light: #FF8D3F;
    --primary-ultra-light: #FFF0E6;
    --accent-color: #4A154B;
    --accent-light: #6A356B;
    --text-color: #2D2D2D;
    --text-light: #6E6E6E;
    --bg-color: #F7F7F9;
    --bg-gradient: linear-gradient(135deg, #FFFFFF, #F7F7F9);
    --card-bg: #FFFFFF;
    --border-light: #E0E0E5;
    --success-color: #00B884;
    --warning-color: #FFB800;
    --danger-color: #FF5252;
    --info-color: #0099FF;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --font-primary: 'Montserrat', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-secondary: 'Poppins', 'Arial', sans-serif;
    --transition-fast: 0.2s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;
}

/* Reset y estilos globales */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    transition: all var(--transition-fast);
}

body {
    font-family: var(--font-primary);
    background-color: var(--bg-color);
    background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDYwIDYwIj48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNNTQgNDhMMzYgNjBsLTE4LTEyTDAgNjBWMGw1NCA0OHoiIGZpbGw9IiNGRkYwRTYiIGZpbGwtb3BhY2l0eT0iMC40Ii8+PC9nPjwvc3ZnPg==');
    background-size: 600px;
    background-position: center;
    color: var(--text-color);
    line-height: 1.6;
    min-height: 100vh;
    padding-bottom: 80px;
    position: relative;
}

@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap');

/* Header futurista */
header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none !important;
    box-shadow: var(--shadow-md);
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
    transform: rotate(30deg);
    pointer-events: none;
}

.header-logo {
    max-height: 70px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

header .container {
    padding: 20px 24px;
}

header h1 {
    color: white;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    font-family: var(--font-secondary);
    letter-spacing: -0.5px;
}

#header-empresa {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: var(--radius-md);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 12px 20px;
    color: white;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

header .text-gray-600 {
    color: rgba(255, 255, 255, 0.8);
    font-weight: 500;
}

/* Navegación con pestañas */
.tab-button {
    padding: 15px 24px;
    font-weight: 600;
    transition: all var(--transition-normal);
    border: none;
    border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    color: var(--text-light);
    margin-right: 4px;
    position: relative;
    overflow: hidden;
    z-index: 1;
    background: transparent;
}

.tab-button::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-color);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.tab-button:hover {
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
    background-color: white;
    font-weight: 700;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
}

.tab-button.active::after {
    transform: scaleX(1);
}

.tab-button:hover::after {
    transform: scaleX(0.5);
}

.tab-button i {
    margin-right: 8px;
    font-size: 16px;
    transition: transform var(--transition-fast);
}

.tab-button:hover i {
    transform: translateY(-2px);
}

.tab-content {
    display: none;
    padding: 10px;
}

.tab-content.active {
    display: block;
    animation: fadeUp 0.4s ease-out;
}

@keyframes fadeUp {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

/* Pasos del formulario */
.form-progress {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-bottom: 40px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

.form-progress::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 0%, var(--border-light) 0%);
    transform: translateY(-50%);
    z-index: 0;
    border-radius: 3px;
    transition: all 0.5s ease;
}

.form-progress[data-progress="1"]::before {
    background: linear-gradient(to right, var(--primary-color) 33%, var(--border-light) 33%);
}

.form-progress[data-progress="2"]::before {
    background: linear-gradient(to right, var(--primary-color) 66%, var(--border-light) 66%);
}

.form-progress[data-progress="3"]::before {
    background: linear-gradient(to right, var(--primary-color) 100%, var(--border-light) 100%);
}

.progress-step {
    background-color: white;
    border: 2px solid var(--border-light);
    color: var(--text-light);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    z-index: 1;
    transition: all var(--transition-normal);
    box-shadow: var(--shadow-sm);
    position: relative;
}

.progress-step::before {
    content: attr(data-label);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-light);
    white-space: nowrap;
    opacity: 0;
    transition: all var(--transition-normal);
}

.progress-step:hover::before {
    opacity: 1;
    bottom: -25px;
}

.progress-step.active {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border-color: var(--primary-dark);
    color: white;
    box-shadow: 0 0 0 5px rgba(255, 107, 0, 0.2);
    transform: scale(1.1);
}

.progress-step.completed {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.progress-step.completed::after {
    content: '✓';
    font-weight: bold;
}

.form-step {
    display: none;
}

.form-step.active {
    display: block;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Tarjetas y contenedores */
.card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal);
    overflow: hidden;
    margin-bottom: 30px;
    position: relative;
}

.card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-5px);
}

.card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 5px;
    background: linear-gradient(to right, var(--primary-color), var(--primary-light));
}

.section-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 25px;
    color: var(--text-color);
    position: relative;
    padding-bottom: 15px;
    font-family: var(--font-secondary);
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(to right, var(--primary-color), var(--primary-light));
    border-radius: 2px;
}

/* Campos de entrada */
.input-field {
    padding: 12px 16px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-family: var(--font-primary);
    color: var(--text-color);
    background-color: #FFFFFF;
    transition: all var(--transition-fast);
    width: 100%;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.input-field:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.15);
    outline: none;
}

.input-field:hover:not(:focus) {
    border-color: #C0C0C5;
}

label {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-color);
    margin-bottom: 8px;
    display: block;
    transition: all var(--transition-fast);
}

/* Grupos de entrada con prefijos/sufijos */
.input-group {
    display: flex;
    align-items: stretch;
    position: relative;
    width: 100%;
}

/* Estilo mejorado para símbolos de moneda y porcentaje */
.input-group-text {
    background: linear-gradient(to bottom, #FFFFFF, #F5F5F7);
    border: 1px solid var(--border-light);
    font-weight: 600;
    color: var(--primary-color);
    height: 100%;
    width: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    box-shadow: inset 0 1px 2px rgba(255, 107, 0, 0.05);
}

/* Símbolo Q al inicio */
.input-group-text:first-child {
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
    border-right: none;
    margin: 0;
    padding: 0;
}

/* Símbolo % al final */
.input-group-text:last-child {
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    border-left: none;
    margin: 0;
    padding: 0;
}

.input-group .input-field {
    flex-grow: 1;
}

/* Ajustes específicos para campos con símbolo al inicio/final */
.input-group .input-field:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.input-group .input-field:not(:last-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

/* Asegurar alineación perfecta con animación en hover */
.input-group:hover .input-group-text {
    border-color: #C0C0C5;
    color: var(--primary-dark);
}

.input-group:focus-within .input-group-text {
    border-color: var(--primary-color);
    color: var(--primary-dark);
}

select.input-field {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236E6E6E' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: calc(100% - 12px) center;
    padding-right: 35px;
}

/* Botones */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    padding: 12px 24px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-normal);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.25);
    position: relative;
    overflow: hidden;
}

.btn-primary::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    background: linear-gradient(rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 107, 0, 0.35);
}

.btn-primary:hover::after {
    opacity: 1;
}

.btn-primary:active {
    transform: translateY(1px);
    box-shadow: 0 2px 8px rgba(255, 107, 0, 0.25);
}

.btn-primary:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.3);
}

.btn-primary i {
    margin-right: 8px;
    font-size: 16px;
}

.btn-primary.bg-gray-500 {
    background: linear-gradient(135deg, #6E6E6E, #4D4D4D);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary.bg-gray-500:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

.btn-primary.bg-green-600 {
    background: linear-gradient(135deg, var(--success-color), darken(var(--success-color), 10%));
    box-shadow: 0 4px 12px rgba(0, 184, 132, 0.25);
}

.btn-primary.bg-green-600:hover {
    box-shadow: 0 6px 16px rgba(0, 184, 132, 0.35);
}

/* Buttons for delete, add, etc. */
.text-blue-600 {
    color: var(--primary-color);
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.text-blue-600:hover {
    color: var(--primary-dark);
    text-decoration: none;
    transform: translateX(5px);
}

.text-blue-600 i {
    margin-right: 8px;
    transition: all var(--transition-fast);
}

.text-blue-600:hover i {
    transform: rotate(90deg);
}

/* Botones de acciones (agregar gastos, etc.) */
#agregar-gasto-legal, 
#agregar-otro-gasto {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    transition: all var(--transition-normal);
    box-shadow: 0 2px 8px rgba(255, 107, 0, 0.2);
}

#agregar-gasto-legal:hover, 
#agregar-otro-gasto:hover {
    background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
}

.btn-eliminar-hipoteca,
.eliminar-gasto-visual, 
.eliminar-otro-gasto {
    color: var(--danger-color);
    background: rgba(255, 82, 82, 0.1);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    cursor: pointer;
}

.btn-eliminar-hipoteca:hover,
.eliminar-gasto-visual:hover, 
.eliminar-otro-gasto:hover {
    background: var(--danger-color);
    color: white;
    transform: rotate(90deg);
}

/* Hipotecas previas */
.hipoteca-previa {
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal);
    position: relative;
}

.hipoteca-previa:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary-light);
}

.hipoteca-previa h3 {
    color: var(--primary-color);
    font-size: 18px;
    font-weight: 600;
}

/* Listas de gastos */
#lista-gastos-legales, 
#lista-otros-gastos {
    min-height: 150px;
    max-height: 250px;
    overflow-y: auto;
    background: linear-gradient(135deg, #FAFAFA, #F5F5F5);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    transition: all var(--transition-normal);
    padding: 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-light) #F0F0F0;
}

#lista-gastos-legales::-webkit-scrollbar, 
#lista-otros-gastos::-webkit-scrollbar {
    width: 6px;
}

#lista-gastos-legales::-webkit-scrollbar-track, 
#lista-otros-gastos::-webkit-scrollbar-track {
    background: #F0F0F0;
    border-radius: 10px;
}

#lista-gastos-legales::-webkit-scrollbar-thumb, 
#lista-otros-gastos::-webkit-scrollbar-thumb {
    background-color: var(--primary-light);
    border-radius: 10px;
}

/* Items de gastos */
.flex.justify-between.items-center.p-2.mb-2.bg-white.border.rounded {
    background: white;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-sm);
    padding: 12px;
    margin-bottom: 8px;
    transition: all var(--transition-normal);
    border-left: 3px solid var(--primary-color);
}

.flex.justify-between.items-center.p-2.mb-2.bg-white.border.rounded:hover {
    box-shadow: var(--shadow-md);
    transform: translateX(5px);
}

.flex.justify-between.items-center.p-2.mb-2.bg-white.border.rounded .font-medium {
    color: var(--text-color);
    font-weight: 600;
}

/* Mensaje de "no hay gastos" */
#no-gastos-legales, 
#no-otros-gastos {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 120px;
    color: var(--text-light);
    font-style: italic;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--radius-sm);
    border: 1px dashed var(--border-light);
}

/* Tablas */
.responsive-table {
    overflow-x: auto;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    background: white;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

thead {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid var(--border-light);
}

td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
    transition: all var(--transition-fast);
}

tbody tr {
    background-color: white;
    transition: all var(--transition-fast);
}

tbody tr:hover {
    background-color: rgba(255, 107, 0, 0.05);
}

/* Checkbox personalizado */
input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    height: 20px;
    width: 20px;
    border: 2px solid var(--border-light);
    border-radius: 4px;
    display: inline-block;
    position: relative;
    cursor: pointer;
    transition: all var(--transition-fast);
    background-color: white;
}

input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

input[type="checkbox"]:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.15);
}

/* Pestaña de Resumen */
#summary-tab {
    font-family: var(--font-primary);
}

#summary-tab * {
    transition: background-color var(--transition-fast), 
                transform var(--transition-fast), 
                box-shadow var(--transition-fast);
}

#summary-tab .border-t-4 {
    border-top: 4px solid var(--primary-color);
}

#summary-tab .text-blue-700 {
    color: var(--primary-color);
}

#summary-tab .bg-blue-50,
#summary-tab .from-blue-50 {
    background: var(--primary-ultra-light);
}

#summary-tab .text-blue-800 {
    color: var(--primary-dark);
}

#summary-tab .bg-blue-100 {
    background-color: var(--primary-ultra-light);
}

#summary-tab .text-blue-700 {
    color: var(--primary-color);
}

#summary-tab .border:hover {
    box-shadow: 0 2px 8px rgba(255, 107, 0, 0.1);
    z-index: 1;
}

#summary-tab button.bg-blue-600 {
    background-color: var(--primary-color);
}

#summary-tab button.bg-blue-600:hover {
    background-color: var(--primary-dark);
}

#summary-tab button.bg-blue-800 {
    background-color: var(--primary-dark);
}

#summary-tab button.bg-blue-800:hover {
    background-color: #d14800;
}

/* Pestaña de Información */
#information-tab .bg-blue-600 {
    background-color: var(--primary-color);
}

#information-tab .text-blue-800,
#information-tab .text-blue-700 {
    color: var(--primary-color);
}

/* Mejoras específicas para campos con símbolos Q y % */
#simbolo-moneda, 
input[id$="interes"] ~ .input-group-text,
input[id$="corretaje"] ~ .input-group-text,
input[id$="gastos-admin"] ~ .input-group-text,
input[id$="legal"] ~ .input-group-text {
    font-family: var(--font-secondary);
    font-weight: 600;
    font-size: 15px;
    color: var(--primary-color);
    background: linear-gradient(135deg, #FFF, #F7F7F9);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
}

/* Resaltar los símbolos Q */
#simbolo-moneda, 
.input-group-text:first-child {
    font-weight: 700;
}

/* Efecto de enfoque para los símbolos */
.input-field:focus + .input-group-text,
.input-group-text + .input-field:focus {
    border-color: var(--primary-color);
    background: white;
}

/* Efectos de animación */
@keyframes highlight {
    0% { background-color: transparent; }
    30% { background-color: rgba(255, 107, 0, 0.2); }
    100% { background-color: transparent; }
}

.field-updated {
    animation: highlight 1.5s ease-in-out;
}

/* Footer */
footer {
    background: linear-gradient(135deg, #2D2D2D, #1A1A1A);
    color: white;
    padding: 30px 0;
    position: absolute;
    bottom: 0;
    width: 100%;
}

footer p {
    opacity: 0.8;
    font-size: 14px;
}

/* Diseño para dispositivos móviles */
@media (max-width: 768px) {
    .tab-button {
        padding: 10px 15px;
        font-size: 14px;
    }
    
    .tab-button i {
        margin-right: 5px;
    }
    
    .section-title {
        font-size: 20px;
    }
    
    .card {
        padding: 15px;
    }
    
    .btn-primary {
        padding: 10px 16px;
        font-size: 14px;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .flex.justify-between {
        flex-direction: column;
    }
    
    .progress-step {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .form-progress::before {
        height: 2px;
    }
    
    header .container {
        flex-direction: column;
        align-items: flex-start;
    }
    
    header .container > div:last-child {
        margin-top: 10px;
    }
    
    .grid.grid-cols-1.md\:grid-cols-2.gap-6 > div {
        margin-bottom: 15px;
    }
    
    .responsive-table {
        max-width: 100%;
        overflow-x: auto;
    }
}

/* Animaciones adicionales */
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(255, 107, 0, 0.4);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(255, 107, 0, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(255, 107, 0, 0);
    }
}

/* Ajuste para tooltip */
.tooltip .tooltip-text {
    background-color: var(--text-color);
    color: white;
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: 13px;
    box-shadow: var(--shadow-md);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
    animation: tooltipFade 0.3s ease;
}

@keyframes tooltipFade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Hacer que el texto del logo sea naranja */
#header-empresa {
    color: #FF6B00 !important; /* Color naranja */
    text-shadow: 0px 0px 1px rgba(0,0,0,0.1); /* Sutil sombra para mejor legibilidad */
  }
  
  /* Opcional: Cambiar también el fondo del contenedor para mejor contraste */
  #header-empresa.text-gray-700 {
    color: #FF6B00 !important; /* Asegura que el color se aplique incluso con otras clases */
  }
  
  /* Para el fondo del contenedor, si deseas cambiarlo */
  .bg-gray-200:has(#header-empresa) {
    background-color: #f8f8f8; /* Un gris más claro */
  }

  /* Cambiar el botón de calcular a naranja */
  #calculate-btn {
    background-color: #FF6B00 !important; /* Naranja */
  }
  
  #calculate-btn:hover {
    background-color: #E05600 !important; /* Naranja más oscuro al pasar el cursor */
  }
  
  /* Asegurarse de que las clases Tailwind no sobreescriban nuestro estilo */
  .bg-green-600, .hover\:bg-green-700:hover {
    background-color: #FF6B00 !important;
  }
  
  .hover\:bg-green-700:hover {
    background-color: #E05600 !important;
  }

  /* Estilos para hacer el cursor (caret) naranja en campos de entrada */

/* Navegadores modernos: Firefox, Chrome, etc. */
input, textarea, select, [contenteditable="true"] {
    caret-color: #FF6B00 !important; /* Color naranja */
}

/* Para darle un poco de enfoque a los campos cuando se les hace clic */
input:focus, textarea:focus, select:focus, [contenteditable="true"]:focus {
    border-color: #FF6B00 !important;
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.2) !important;
    outline: none !important;
}

/* Clase específica para tus campos de entrada de Tailwind */
.input-field:focus {
    border-color: #FF6B00 !important;
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.2) !important;
    outline: none !important;
}

/* Para mejorar la visibilidad del texto seleccionado */
::selection {
    background-color: rgba(255, 107, 0, 0.3) !important;
    color: #000 !important;
}

/* Para asegurar que el cambio de color del cursor se aplique en todo tipo de navegadores */
@supports (-webkit-caret-color: #FF6B00) or (caret-color: #FF6B00) {
    input, textarea, select, [contenteditable="true"] {
        -webkit-caret-color: #FF6B00 !important;
        caret-color: #FF6B00 !important;
    }
}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <!-- Logo placeholder -->
				<!-- Busca en el header y cambia la parte del logo por esto: -->
				<div class="bg-gray-200 w-64 h-16 flex items-center justify-center mr-4 rounded">
					<span id="header-empresa" class="text-lg font-bold text-gray-700"></span>
				</div>
                <h1 class="text-2xl font-bold text-gray-800">Cotizador de Hipotecas</h1>
            </div>
            <div>
                <p class="text-sm text-gray-600">Fecha: <span id="current-date"></span></p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
      <!-- Tabs Navigation -->
				<div class="mb-6 border-b border-gray-200">
					<div class="flex">
						<button class="tab-button active" data-tab="form">
							<i class="fas fa-file-alt mr-2"></i>Formulario
						</button>
						<button class="tab-button" data-tab="information">
							<i class="fas fa-info-circle mr-2"></i>Información
						</button>
                        <button class="tab-button" data-tab="summary">
							<i class="fas fa-chart-pie mr-2"></i>Resumen
						</button>
					</div>
				</div>

        <!-- Form Tab -->
        <div id="form-tab" class="tab-content active">
				<div class="form-progress mb-8">
					<div class="progress-step active cursor-pointer" data-step="1">1</div>
					<div class="progress-step cursor-pointer" data-step="2">2</div>
					<div class="progress-step cursor-pointer" data-step="3">3</div>
					<div class="progress-step cursor-pointer" data-step="4">4</div>
				</div>

            <!-- Step 1: Información del Cliente -->
            <div class="form-step active">
                <div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Información del Cliente</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Empresa
                            </label>
                            <select id="empresa" class="input-field w-full">
								<option value=""></option>
                                <option value="Hollem, S.A.">Hollem, S.A.</option>
                                <option value="Corporación Calem, S.A.">Corporación Calem, S.A.</option>
                                <option value="Coopexpress">Coopexpress</option>
                            </select>
                        </div>
						
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">
								Fecha de Desembolso
							</label>
							<input type="date" id="fecha-formulario" class="input-field w-full" value="">
						</div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Solicitud
                            </label>
                            <select id="tipo-solicitud" class="input-field w-full">
								<option value=""></option>
                                <option value="Nuevo">Nuevo</option>
                                <option value="Renovación">Ampliación</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Cliente / Deudor
                            </label>
						<input type="text" id="cliente" class="input-field w-full" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                DPI
                            </label>
							<input type="text" id="dpi" class="input-field w-full" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                NIT
                            </label>
							<input type="number" id="nit" class="input-field w-full" value="">
                        </div>
                        
						<div>
						<label class="block text-sm font-medium text-gray-700 mb-2">
							Asesor
						</label>
						<select id="asesor" class="input-field w-full">
							            <option value="">Seleccione...</option>
										<option value="Asesor1">Brayan Gonzalez</option>
										<option value="Asesor2">Edwin Sasvin</option>
										<option value="Asesor3">Emely Jimenez</option>
										<option value="Asesor4">Kevin De Leon</option>
										<option value="Asesor5">Lisbeth Aguilar</option>
										<option value="Asesor6">Lorena Godinez</option>
										<option value="Asesor7">Miguel Pú</option>
										<option value="Asesor8">Rudy Monroy</option>
										<option value="Asesor9">Sonia Guzman</option>
										<option value="Asesor10">Veronica Sandoval</option>
										<option value="Asesor11">Gabriel Urrea</option>
										<option value="Asesor11">Anahi Rodriguez</option>
										<option value="Asesor11">Angelica Rosales</option>
										<option value="Asesor11">Carlos Diaz</option>
										<option value="Asesor11">Evelyn Roldán</option>
										<option value="Asesor11">Lidia Paná</option>
										<option value="Asesor11">Jennifer Pop</option>
										<option value="Asesor11">Sucely Cho</option>
										<option value="Asesor11">Rigoberto Pop</option>
										<option value="Asesor11">Oscar Tul</option>
						</select>
					</div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button id="to-step-2" class="btn-primary">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Información del Préstamo -->
            <div class="form-step">
                <div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Información del Préstamo</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Moneda
                            </label>
                            <select id="moneda" class="input-field w-full">
                                <option value="GTQ">Quetzales (GTQ)</option>
                                <option value="USD">Dólares (USD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Préstamo
                            </label>
                            <select id="tipo-prestamo" class="input-field w-full">
                                <option value="Compraventa">Compraventa</option>
                                <option value="Mutuo Hipotecario">Mutuo Hipotecario</option>
                                <option value="Adjudicacion">Adjudicación</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Capital Solicitado
                            </label>
                            <!-- Por ejemplo, para el capital solicitado -->
							<div class="input-group">
								<span id="simbolo-moneda" class="input-group-text">Q</span>
								<input type="number" id="capital" class="input-field w-full" value="">
							</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                % Interés Mensual
                            </label>
                            <div class="input-group">
                                <input type="number" id="interes" class="input-field w-full" value="2.25" step="0.01">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    % Corretaje
                                </label>
                                <div class="input-group">
                                    <input type="number" id="corretaje" class="input-field w-full" value="5" step="0.01">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    % Gastos Administrativos
                                </label>
                                <div class="input-group">
                                    <input type="number" id="gastos-admin" class="input-field w-full" value="5" step="0.01">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
							
							<div>
							<label class="block text-sm font-medium text-gray-700 mb-2">
								% Legal
							</label>
							<div class="input-group">
								<input type="number" id="legal" class="input-field w-full" value="3" step="0.01">
								<span class="input-group-text">%</span>
							</div>
						</div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button id="to-step-1" class="btn-primary bg-gray-500 hover:bg-gray-600">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button id="to-step-3" class="btn-primary">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Información de la Propiedad -->
            <div class="form-step">
                <div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Información de la Propiedad</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Cantidad de Fincas a Hipotecar
                            </label>
							<input type="number" id="cantidad-fincas" class="input-field w-full" value="">
                        </div>
						
						 <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Meses completos a adelantar
                            </label>
							<input type="number" id="meses-adelantar" class="input-field w-full" value="">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Impuesto
                            </label>
                            <select id="tipo-impuesto" class="input-field w-full">
                                <option value="IVA 12%">IVA 12%</option>
                                <option value="TIMBRE 3%">TIMBRE 3%</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Valor según RGP
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">Q</span>
								<input type="number" id="valor-rgp" class="input-field w-full" value="">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Valor Según Municipalidad / Catastro
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">Q</span>
									<input type="number" id="valor-catastro" class="input-field w-full" value="">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Hipotecas Previas</h2>
                    
                    <div class="mb-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="cancela-hipoteca" class="form-checkbox h-5 w-5 text-blue-600" checked>
                            <span class="ml-2 text-gray-700">¿Cancela Hipoteca Previa?</span>
                        </label>
                    </div>
                    
                    <div id="hipotecas-previas-container">
					<div class="hipoteca-previa mb-4 p-4 border border-gray-200 rounded-lg">
						<div class="flex justify-between items-center mb-3">
							<h3 class="font-semibold text-lg">Hipoteca Previa 1</h3>
							<button type="button" class="btn-eliminar-hipoteca text-red-500 hover:text-red-700" disabled>
								<i class="fas fa-trash"></i>
							</button>
						</div>
						
						<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">
									Monto Hipoteca Previa
								</label>
								<div class="input-group">
									<span class="input-group-text">Q</span>
									<input type="number" name="monto-hipoteca" class="input-field w-full" value="">
								</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">
									Nombre del Acreedor Hipotecario
								</label>
								<input type="text" name="acreedor" class="input-field w-full" value="">
							</div>
							<div>
								<label class="block text-sm font-medium text-gray-700 mb-2">
									Monto por emisión de CTP
								</label>
								<div class="input-group">
									<span class="input-group-text">Q</span>
									<input type="number" name="monto-ctp" class="input-field w-full" value="">
								</div>
							</div>
						</div>
					</div>
                        
                        <button id="add-hipoteca" class="text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i> Agregar otra hipoteca
                        </button>
                    </div>
                </div>
				
				<div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Gastos</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Columna de Gastos Legales -->
                        <div class="gastos-panel">
                            <h3 class="text-lg font-semibold mb-3">Gastos Legales</h3>
                            <div class="mb-3">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        Seleccione un Gasto Legal
    </label>
    <select id="select-gasto-legal" class="input-field w-full mb-4">
        <option value="">Seleccione...</option>
						<option value="Aviso a la Municipalidad" data-honorario="850" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Aviso a la Municipalidad</option>
						<option value="Carta Total de Pago" data-honorario="1100" data-reembolso="160" data-retenido="0" data-reembolso-ctp="0">Carta Total de Pago</option>
						<option value="Certificación de DPI" data-honorario="0" data-reembolso="0" data-retenido="150" data-reembolso-ctp="0">Certificación de DPI</option>
						<option value="Consulta Electrónica RGP" data-honorario="0" data-reembolso="0" data-retenido="50" data-reembolso-ctp="0">Consulta Electrónica RGP</option>
						<option value="Actualización de Nomenclatura" data-honorario="1100" data-reembolso="160" data-retenido="0" data-reembolso-ctp="0">Actualización de Nomenclatura</option>
						<option value="Certificación de Testimonio Especial" data-honorario="0" data-reembolso="150" data-retenido="0" data-reembolso-ctp="0">Certificación de Testimonio Especial</option>
						<option value="Memorial De Cancelacion O Inscripcion" data-honorario="1100" data-reembolso="160" data-retenido="0" data-reembolso-ctp="0">Memorial De Cancelacion O Inscripcion</option>
						<option value="Actas notariales de Declaración Jurada" data-honorario="850" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Actas notariales de Declaración Jurada</option>
						<option value="Iva de Cancelación de Usufructos" data-honorario="0" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Iva de Cancelación de Usufructos</option>
						<option value="Certificación de Identificación de Persona" data-honorario="0" data-reembolso="0" data-retenido="100" data-reembolso-ctp="0">Certificación de Identificación de Persona</option>
						<option value="Certificación de nacimiento" data-honorario="0" data-reembolso="0" data-retenido="100" data-reembolso-ctp="0">Certificación de nacimiento</option>
						<option value="Desistimiento ante los juzgados" data-honorario="1750" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Desistimiento ante los juzgados</option>
						<option value="Anotación provisional al tener Hipoteca" data-honorario="0" data-reembolso="0" data-retenido="400" data-reembolso-ctp="0">Anotación provisional al tener Hipoteca</option>
						<option value="Certificado de Defunción" data-honorario="0" data-reembolso="0" data-retenido="100" data-reembolso-ctp="0">Certificado de Defunción</option>
						<option value="Identificación de Persona" data-honorario="1750" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Identificación de Persona</option>
						<option value="Escritura de rescisión" data-honorario="1750" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Escritura de rescisión</option>
						<option value="Rectificación de inscripciones" data-honorario="850" data-reembolso="160" data-retenido="0" data-reembolso-ctp="0">Rectificación de inscripciones</option>
						<option value="Certificación al RGP" data-honorario="0" data-reembolso="0" data-retenido="150" data-reembolso-ctp="0">Certificación al RGP</option>
						<option value="Identificación de Tercero" data-honorario="1750" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Identificación de Tercero</option>
						<option value="Multas AGP" data-honorario="25" data-reembolso="0" data-retenido="0" data-reembolso-ctp="0">Multas AGP</option>
                    </select>
        
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Cantidad
                        </label>
                        <div class="flex items-center">
                            <input type="number" id="gasto-legal-cantidad" class="input-field w-16" value="1" min="1">
                            <button id="agregar-gasto-legal" class="ml-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                <i class="fas fa-plus-circle mr-2"></i>Agregar Gasto
                            </button>
                        </div>
                    </div>
                </div>
            
            <div class="mt-4">
                <h4 class="text-md font-medium mb-2">Gastos Legales Seleccionados</h4>
                <div id="lista-gastos-legales" class="border rounded-lg p-3 min-h-[150px] bg-gray-50">
                    <!-- Aquí se añadirán los gastos seleccionados -->
                    <p class="text-gray-500 text-sm text-center pt-4" id="no-gastos-legales">No hay gastos legales seleccionados</p>
                </div>
            </div>
        </div>
        
        <!-- Solución simple para alinear costo y botón -->
        <div class="gastos-panel">
            <h3 class="text-lg font-semibold mb-3">Otros Gastos</h3>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Seleccione un Gasto Adicional
                </label>
                <select id="select-otro-gasto" class="input-field w-full mb-3">
                    <option value="">Seleccione...</option>
                    <option value="Avalúo" data-cost="800">Avalúo</option>
                    <option value="Viáticos" data-cost="1200">Viáticos</option>
                    <option value="Freelance" data-cost="500">Freelance</option>
                    <option value="IVA Cancelación de Usufructos" data-cost="100">IVA Cancelación de Usufructos</option>
                    <option value="Otro gasto adicional" data-cost="0">Otro gasto adicional</option>
                </select>
        
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Costo del Gasto
                    </label>
                    <div class="flex items-center">
                        <div class="input-group flex-grow">
                            <span class="input-group-text">Q</span>
                            <input type="number" id="otro-gasto-costo" class="input-field w-full" value="0" min="0" step="0.01">
                        </div>
                        <button id="agregar-otro-gasto" class="ml-3 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fas fa-plus-circle mr-2"></i>Agregar Gasto
                        </button>
                    </div>
                </div>
            </div>
    
    <div class="mt-4">
        <h4 class="text-md font-medium mb-2">Otros Gastos Seleccionados</h4>
        <div id="lista-otros-gastos" class="border rounded-lg p-3 min-h-[150px] bg-gray-50">
            <p class="text-gray-500 text-sm text-center pt-4" id="no-otros-gastos">No hay otros gastos seleccionados</p>
             </div>
         </div>
        </div>
    </div>
</div>
                
                <div class="flex justify-between">
                    <button id="to-step-2-from-3" class="btn-primary bg-gray-500 hover:bg-gray-600">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button id="to-step-4" class="btn-primary">
                        Siguiente <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Desembolsos -->
            <div class="form-step">
                <div class="bg-white p-6 mb-6 card">
                    <h2 class="text-xl font-bold mb-4 section-title">Desembolsos</h2>
                    
						<div class="responsive-table">
							<table class="min-w-full divide-y divide-gray-200">
								<thead>
									<tr>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Desembolso</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Beneficiario</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Monto</th>
										<th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Concepto</th>
									</tr>
								</thead>
								<tbody class="bg-white divide-y divide-gray-200" id="desembolsos-container">
									<!-- La tabla inicia vacía -->
								</tbody>
							</table>
						</div>
											
                    <div class="mt-4">
                        <button id="add-desembolso" class="text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i> Agregar otro desembolso
                        </button>
                    </div>
                </div>
                
                
                <div class="flex justify-between">
                    <button id="to-step-3-from-4" class="btn-primary bg-gray-500 hover:bg-gray-600">
                        <i class="fas fa-arrow-left mr-2"></i> Anterior
                    </button>
                    <button id="calculate-btn" class="btn-primary bg-green-600 hover:bg-green-700">
                        <i class="fas fa-calculator mr-2"></i> Calcular Cotización
                    </button>
                </div>
            </div>
        </div>

<!-- Reemplazar todo el contenido dentro del div id="summary-tab" -->
<div id="summary-tab" class="tab-content">
    <div class="bg-white shadow-md rounded-lg border border-gray-200 overflow-hidden">
      <!-- Encabezado con borde superior -->
      <div class="border-t-4 border-blue-600 bg-gradient-to-r from-blue-50 to-white py-3 px-4 flex justify-between items-center">
        <h2 id="print-empresa" class="text-xl font-bold text-blue-700"></h2>
        <h3 class="text-sm font-semibold text-gray-600">PROPUESTA DE HIPOTECA</h3>
      </div>
      
      <!-- Datos del cliente y porcentajes - Grid de 2 columnas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 border-b border-gray-200">
        <!-- Columna 1: Datos del cliente -->
        <div class="space-y-2">
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">Cliente</label>
            <div id="print-cliente" class="font-medium p-1 border border-gray-200 bg-white rounded"></div>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="flex flex-col">
              <label class="text-xs text-gray-500">DPI</label>
              <div id="print-dpi" class="font-medium p-1 border border-gray-200 bg-white rounded"></div>
            </div>
            
            <div class="flex flex-col">
              <label class="text-xs text-gray-500">NIT</label>
              <div id="print-nit" class="font-medium p-1 border border-gray-200 bg-white rounded"></div>
            </div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">Tipo de Préstamo</label>
            <div id="print-tipo-prestamo" class="font-medium p-1 border border-gray-200 bg-white rounded"></div>
          </div>
        </div>
        
        <!-- Columna 2: Porcentajes -->
        <div class="grid grid-cols-3 gap-2">
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">% Interés</label>
            <div id="print-interes" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">Interés Mensual</label>
            <div id="print-interes-mensual" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">Meses Adelantados</label>
            <div id="print-meses-adelantados" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">% Corretaje</label>
            <div id="print-corretaje" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">% Gasto Admón.</label>
            <div id="print-gastos-admin" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
          
          <div class="flex flex-col">
            <label class="text-xs text-gray-500">% Legal</label>
            <div id="print-legal" class="font-medium p-1 border border-gray-200 bg-white rounded text-center"></div>
          </div>
        </div>
      </div>
      
      <!-- Contenedor para las dos tablas -->
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 p-4">
        <!-- Desglose financiero (7 columnas) -->
        <div class="md:col-span-7 border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-100 border-b border-gray-200 px-3 py-2 font-medium text-gray-700">
            Desglose Financiero
          </div>
          <div class="overflow-auto max-h-96">
            <table class="w-full text-sm">
                <tbody>
                    <!-- Grupo 1: Monto Solicitado y deducciones -->
                    <tr class="border-b border-gray-100">
                      <td class="py-1 px-3 font-medium">Monto Solicitado</td>
                      <td class="py-1 px-3 text-right font-medium bg-blue-50 text-blue-800" id="desglose-monto"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Intereses del Mes en Curso</td>
                      <td class="py-1 px-3 text-right" id="desglose-intereses-mes"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Intereses Adelantados</td>
                      <td class="py-1 px-3 text-right" id="desglose-intereses-adelantados"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Corretaje</td>
                      <td class="py-1 px-3 text-right" id="desglose-corretaje"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Gastos Administrativos</td>
                      <td class="py-1 px-3 text-right" id="desglose-gastos-admin"></td>
                    </tr>
                     <!-- Filas para gastos específicos de Coopexpress -->
                    <tr class="text-red-600" id="desglose-courier-row" style="display: none;">
                        <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Courier - Documentación</td>
                        <td class="py-1 px-3 text-right" id="desglose-courier">(75.00)</td>
                    </tr>
                    <tr class="text-red-600" id="desglose-coop-row" style="display: none;">
                        <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Cuota Cooperativa</td>
                        <td class="py-1 px-3 text-right" id="desglose-coop">(100.00)</td>
                    </tr>
                    <tr class="border-t border-gray-300">
                      <td class="py-1 px-3 font-medium">Sub Total</td>
                      <td class="py-1 px-3 text-right font-medium bg-gray-50" id="desglose-subtotal"></td>
                    </tr>
                    
                    <!-- Grupo 2: Gastos de Inscripción -->
                    <tr class="border-t border-gray-200 bg-gray-50">
                      <td class="py-1 px-3 font-medium">Gastos de Inscripción de Hipoteca</td>
                      <td class="py-1 px-3 text-right font-medium text-red-600" id="desglose-gastos-inscripcion"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Honorarios escrituración</td>
                      <td class="py-1 px-3 text-right" id="desglose-honorarios"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Timbre Notarial</td>
                      <td class="py-1 px-3 text-right" id="desglose-timbre"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Registro</td>
                      <td class="py-1 px-3 text-right" id="desglose-registro"></td>
                    </tr>
                    <tr class="text-red-600">
                      <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Timbres Fiscales</td>
                      <td class="py-1 px-3 text-right" id="desglose-timbres"></td>
                    </tr>
                    
                    <!-- Grupo 3: Otros Gastos Legales -->
                    <tr class="border-t border-gray-200 bg-gray-50">
                      <td class="py-1 px-3 font-medium">Otros Gastos Legales</td>
                      <td class="py-1 px-3 text-right font-medium text-red-600" id="desglose-otros-gastos-legales"></td>
                    </tr>
                    
                    <!-- Grupo 4: Otros gastos -->
                    <tr class="border-t border-gray-200 bg-gray-50">
                      <td class="py-1 px-3 font-medium">Otros gastos</td>
                      <td class="py-1 px-3 text-right font-medium text-red-600" id="desglose-otros-gastos"></td>
                    </tr>
                    
                    <!-- Totales -->
                    <tr class="border-t border-gray-300 font-medium">
                      <td class="py-1 px-3">Total Gastos</td>
                      <td class="py-1 px-3 text-right text-red-700 bg-red-50" id="desglose-total-gastos"></td>
                    </tr>
                    <tr class="border-t-2 border-blue-500 font-bold">
                      <td class="py-2 px-3 text-blue-900">Recibe de la Hipoteca</td>
                      <td class="py-2 px-3 text-right text-blue-900 bg-yellow-100" id="desglose-total-recibe"></td>
                    </tr>
                  </tbody>                  
            </table>
          </div>
        </div>
        
        <!-- Tabla de desembolsos (5 columnas) -->
        <div class="md:col-span-5 border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-100 border-b border-gray-200 px-3 py-2 font-medium text-gray-700">
            Detalle de Desembolsos
          </div>
          <div class="overflow-auto max-h-96">
            <table class="w-full text-sm">
              <thead class="bg-blue-100 text-blue-700">
                <tr>
                  <th class="py-2 px-1 text-left font-medium text-xs">Fecha</th>
                  <th class="py-2 px-1 text-left font-medium text-xs">Beneficiario</th>
                  <th class="py-2 px-1 text-right font-medium text-xs">Monto</th>
                  <th class="py-2 px-1 text-left font-medium text-xs">Desembolso</th>
                  <th class="py-2 px-1 text-left font-medium text-xs">Concepto</th>
                  <th class="py-2 px-1 text-left font-medium text-xs">Banco</th>
                  <th class="py-2 px-1 text-left font-medium text-xs">Empresa</th>
                </tr>
              </thead>
              <tbody id="desembolsos-print">
                <!-- Las filas de desembolsos se generarán dinámicamente -->
              </tbody>
              <tfoot class="bg-gray-50 border-t border-gray-200">
                <tr>
                  <td colspan="2" class="py-2 px-1 text-right font-medium">Total</td>
                  <td class="py-2 px-1 text-right font-medium text-blue-700" id="total-desembolsos"></td>
                  <td colspan="4"></td>
                </tr>
              </tfoot>
              </tfoot>
            </table>
        </table>
    </div>
    <!-- Nuevo campo para mostrar diferencia -->
    <div class="px-3 py-3 border-t border-gray-200 bg-yellow-50">
      <div class="flex justify-between items-center">
        <div class="font-medium text-gray-700">Diferencia contra cotización</div>
        <div id="diferencia-cotizacion" class="text-right font-bold text-red-600"></div>
      </div>
      <div class="text-xs text-gray-500 text-right italic">(Diferencia debe ser 0)</div>
    </div>
          </div>
        </div>
      </div>
      
      <!-- Área de firmas -->
      <div class="grid grid-cols-2 gap-8 px-16 pb-8 pt-4 border-t border-gray-200 bg-gray-50">
        <div class="text-center">
          <div class="h-px w-48 bg-gray-300 mx-auto my-4"></div>
          <div class="text-sm font-medium">Elaboró</div>
        </div>
        <div class="text-center">
          <div class="h-px w-48 bg-gray-300 mx-auto my-4"></div>
          <div class="text-sm font-medium">Revisó</div>
        </div>
      </div>
      
      <!-- Botones compactos en footer -->
       
      <div class="px-4 py-2 border-t border-gray-200 flex justify-end">
        <!-- 
        <button id="print-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded shadow-sm transition-all mr-2 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0v3H7V4h6zm-5 7a1 1 0 112 0 1 1 0 01-2 0zm7 0a1 1 0 10-2 0 1 1 0 002 0z" clip-rule="evenodd" />
          </svg>
          Imprimir
        </button>
        -->
        <!-- Nuevo botón de Tabla Desembolsos -->
  <button id="desembolsos-btn" class="bg-orange-600 hover:bg-orange-700 text-white text-sm px-3 py-1 rounded shadow-sm transition-all mr-2 flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
    </svg>
    Tabla Desembolsos
  </button>
        <button id="save-pdf-btn" class="bg-blue-800 hover:bg-blue-900 text-white text-sm px-3 py-1 rounded shadow-sm transition-all flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
          </svg>
          PDF
        </button>
      </div>
    </div>
  </div>
					<!-- Nueva pestaña de Información -->
			<div id="information-tab" class="tab-content">
				<div class="bg-white p-6 mb-6 card">
									<div class="relative mb-8">
					<div class="absolute inset-0 flex items-center">
						<div class="w-full border-t border-gray-300"></div>
					</div>
					<div class="relative flex justify-center">
						<span class="px-6 py-3 bg-blue-600 text-white text-xl font-bold rounded-lg shadow-lg">
							INFORMACIÓN DEL CRÉDITO
						</span>
					</div>
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
						<!-- Primera fila -->
					<div class="flex items-center mb-2">
						<label class="w-1/3 font-semibold text-blue-800">Fecha</label>
						<div class="w-2/3 border border-gray-300 p-3 bg-white rounded-md shadow-sm hover:shadow-md transition-shadow duration-300" id="info-fecha"></div>
					</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Tipo de solicitud</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-tipo-solicitud"></div>
						</div>
						
						<!-- Segunda fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Empresa</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-empresa"></div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Moneda</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-moneda"></div>
						</div>
						
						<!-- Tercera fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Tipo de Préstamo</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-tipo-prestamo"></div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Mes</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-mes"></div>
						</div>
						
						<!-- Cuarta fila -->
						<div class="flex items-center col-span-2">
							<label class="w-1/6 font-semibold">Cliente</label>
							<div class="w-5/6 border border-gray-300 p-2 bg-gray-50" id="info-cliente"></div>
						</div>
						
						<!-- Quinta fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">DPI</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-dpi"></div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">NIT</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-nit"></div>
						</div>
						
						<!-- Sexta fila -->
						<div class="flex items-center col-span-2">
							<label class="w-1/6 font-semibold">Asesor</label>
							<div class="w-5/6 border border-gray-300 p-2 bg-gray-50" id="info-asesor"></div>
						</div>
						
						<!-- Séptima fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Capital Solicitado</label>
							<div class="flex items-center w-2/3">
								<span class="px-2 py-2 bg-gray-200 border border-gray-300 border-r-0" id="info-moneda-simbolo"></span>
								<div class="flex-grow border border-gray-300 p-2 bg-gray-50" id="info-capital"></div>
							</div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">% Int. Mensual</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-interes"></div>
						</div>
						
						<!-- Octava fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">% Corretaje</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-corretaje"></div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">% Gasto Admón.</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-gasto-admin"></div>
						</div>
						
						<!-- Novena fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">% Legal</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-legal"></div>
						</div>
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Meses completos a adelantar</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-meses-adelantar"></div>
						</div>
						
						<!-- Décima fila -->
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Cantidad de Fincas a Hipotecar</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-cantidad-fincas"></div>
						</div>
					</div>
					
					<h2 class="text-xl font-bold mb-6 mt-8 text-center bg-gray-800 text-white py-3" id="info-tipo-prestamo-titulo">COMPRAVENTA</h2>
					
					<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Tipo de Impuesto</label>
							<div class="w-2/3 border border-gray-300 p-2 bg-gray-50" id="info-tipo-impuesto"></div>
						</div>
						<div></div>
						
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Precio de Venta según Escritura Pública</label>
							<div class="flex items-center w-2/3">
								<span class="px-2 py-2 bg-gray-200 border border-gray-300 border-r-0" id="info-moneda-simbolo2"></span>
								<div class="flex-grow border border-gray-300 p-2 bg-gray-50" id="info-valor-rgp"></div>
							</div>
						</div>
						<div></div>
						
						<div class="flex items-center">
							<label class="w-1/3 font-semibold">Precio de Venta según Matrícula fiscal</label>
							<div class="flex items-center w-2/3">
								<span class="px-2 py-2 bg-gray-200 border border-gray-300 border-r-0" id="info-moneda-simbolo3"></span>
								<div class="flex-grow border border-gray-300 p-2 bg-gray-50" id="info-valor-catastro"></div>
							</div>
						</div>
					</div>
					
					<h2 class="text-xl font-bold mb-6 mt-8 text-center bg-gray-800 text-white py-3">HIPOTECA PREVIA</h2>
					
					<div id="info-hipotecas-container" class="space-y-4">
						<!-- Se llenarán dinámicamente las hipotecas previas -->
					</div>
					
					<h2 class="text-xl font-bold mb-6 mt-8 text-center bg-gray-800 text-white py-3">DETALLE DE GASTOS</h2>
					
					<div class="overflow-x-auto">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-100">
								<tr>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">No.</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Tipo de Gasto</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Cantidad</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Honorarios</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Reembolso</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Retenido</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Reembolso CTP</th>
									<th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Total</th>
									<th class="px-4 py-2"></th>
								</tr>
							</thead>
							    <tbody id="gastos-legales-table" class="bg-white divide-y divide-gray-200">
								<!-- Se llenarán dinámicamente los gastos -->
							</tbody>
							
							<!-- ... Tu código de tabla aquí ... -->
							<tfoot>
								<tr class="border-t-2 border-gray-300">
									<td colspan="3" class="px-4 py-2 text-right font-bold">Totales</td>
									<td id="total-honorarios-table" class="px-4 py-2 font-bold">0.00</td>
									<td id="total-reembolso-table" class="px-4 py-2 font-bold">0.00</td>
									<td id="total-retenido-table" class="px-4 py-2 font-bold">0.00</td>
									<td id="total-reembolso-ctp-table" class="px-4 py-2 font-bold">0.00</td>
									<td id="total-gastos-table" class="px-4 py-2 font-bold">0.00</td>
									<td></td> <!-- Columna para el botón eliminar -->
								</tr>
							</tfoot>
						</table>
					
					
					<div class="mt-6 text-right">
								<div class="inline-flex items-center">
							<span class="font-semibold mr-4">Valor a Reembolsar a Legal</span>
							<div class="border border-gray-300 p-2 bg-gray-50 w-40" id="valor-reembolsar-legal">0.00</div>
						</div>
					</div>
				</div>
			</div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm"></p>
                </div>
                <div>
                    <p class="text-sm">Versión 1.0 | Desarrollado por Departamento de Sistemas</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Función para mostrar u ocultar los gastos de Coopexpress
        function toggleCoopexpressExpenses() {
            const empresa = document.getElementById('empresa').value;
            const courierRow = document.getElementById('desglose-courier-row');
            const coopRow = document.getElementById('desglose-coop-row');
            
            if (!courierRow || !coopRow) {
                // Si las filas no existen, crearlas primero
                createCoopexpressRows();
            }
            
            // Obtener las referencias nuevamente en caso de que se hayan creado
            const updatedCourierRow = document.getElementById('desglose-courier-row');
            const updatedCoopRow = document.getElementById('desglose-coop-row');
            
            const showRows = empresa === "Coopexpress";
            
            if (updatedCourierRow) updatedCourierRow.style.display = showRows ? 'table-row' : 'none';
            if (updatedCoopRow) updatedCoopRow.style.display = showRows ? 'table-row' : 'none';
            
            console.log(`Empresa: ${empresa}, Mostrar gastos Coopexpress: ${showRows}`);
        }
        
        // Función para crear las filas de Coopexpress si no existen
        function createCoopexpressRows() {
            // Buscar la tabla
            const tbody = document.querySelector('#summary-tab table tbody');
            if (!tbody) return;
            
            // Buscar la fila después de la cual insertar (después de Gastos Administrativos)
            const adminRow = document.querySelector('#desglose-gastos-admin');
            if (!adminRow) return;
            
            const adminTR = adminRow.closest('tr');
            if (!adminTR) return;
            
            // Verificar si ya existen las filas
            if (!document.getElementById('desglose-courier-row')) {
                // Crear fila de Courier
                const courierRow = document.createElement('tr');
                courierRow.id = 'desglose-courier-row';
                courierRow.className = 'text-red-600';
                courierRow.innerHTML = `
                    <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Courier - Documentación</td>
                    <td class="py-1 px-3 text-right" id="desglose-courier">(75.00)</td>
                `;
                
                // Insertar después de gastos administrativos
                adminTR.insertAdjacentElement('afterend', courierRow);
            }
            
            // Verificar nuevamente por si acaba de ser creada
            const courierRow = document.getElementById('desglose-courier-row');
            
            if (!document.getElementById('desglose-coop-row') && courierRow) {
                // Crear fila de Cuota Cooperativa
                const coopRow = document.createElement('tr');
                coopRow.id = 'desglose-coop-row';
                coopRow.className = 'text-red-600';
                coopRow.innerHTML = `
                    <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>Cuota Cooperativa</td>
                    <td class="py-1 px-3 text-right" id="desglose-coop">(100.00)</td>
                `;
                
                // Insertar después de la fila de courier
                courierRow.insertAdjacentElement('afterend', coopRow);
            }
            
            // Inicialmente ocultar las filas
            const updatedCourierRow = document.getElementById('desglose-courier-row');
            const updatedCoopRow = document.getElementById('desglose-coop-row');
            
            if (updatedCourierRow) updatedCourierRow.style.display = 'none';
            if (updatedCoopRow) updatedCoopRow.style.display = 'none';
        }
        
        // Función para agregar event listeners a todos los campos del formulario
        function initFormEventListeners() {
            // Lista de todos los IDs de los campos del formulario que afectan la pestaña de información
            const fieldIds = [
                'fecha-formulario', 'tipo-solicitud', 'empresa', 'moneda', 'tipo-prestamo',
                'cliente', 'dpi', 'nit', 'asesor', 'capital', 'interes', 'corretaje',
                'gastos-admin', 'legal', 'meses-adelantar', 'cantidad-fincas',
                'tipo-impuesto', 'valor-rgp', 'valor-catastro', 'cancela-hipoteca'
            ];
            
            // Agregar event listeners a cada campo
            fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Diferentes tipos de eventos según el tipo de campo
                    if (element.type === 'checkbox') {
                        element.addEventListener('change', debounceUpdateInfo);
                    } else if (element.tagName === 'SELECT') {
                        element.addEventListener('change', debounceUpdateInfo);
                    } else {
                        // Para inputs de texto y número
                        element.addEventListener('input', debounceUpdateInfo);
                        element.addEventListener('change', debounceUpdateInfo);
                    }
                }
            });
            
            // Agregar event listeners para hipotecas previas
            document.getElementById('add-hipoteca').addEventListener('click', debounceUpdateInfo);
            
            // Usar delegación de eventos para detectar cambios en hipotecas previas
            document.addEventListener('change', function(e) {
                const target = e.target;
                if (target.closest('.hipoteca-previa') && 
                    (target.name === 'monto-hipoteca' || 
                     target.name === 'acreedor' || 
                     target.name === 'monto-ctp')) {
                    debounceUpdateInfo();
                }
            });
            
            // También detectar cuando se elimina una hipoteca
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-eliminar-hipoteca')) {
                    setTimeout(debounceUpdateInfo, 100);
                }
            });
            
            // Actualizar cuando se agreguen o eliminen gastos
            document.getElementById('agregar-gasto-legal').addEventListener('click', debounceUpdateInfo);
            document.getElementById('agregar-otro-gasto').addEventListener('click', debounceUpdateInfo);
            
            // Usar delegación de eventos para eliminar gastos
            document.addEventListener('click', function(e) {
                if (e.target.closest('.eliminar-gasto') || 
                    e.target.closest('.eliminar-gasto-visual') ||
                    e.target.closest('.eliminar-otro-gasto')) {
                    setTimeout(debounceUpdateInfo, 100);
                }
            });
        }
        
        // Función simple de debounce para evitar actualizaciones excesivas
        let debounceTimer;
        function debounceUpdateInfo() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                // Solo actualizar si la pestaña de información está activa
                const infoTab = document.getElementById('information-tab');
                if (infoTab && infoTab.classList.contains('active')) {
                    updateInformationTab();
                } else {
                    // Marcar que hay actualizaciones pendientes
                    window.pendingGastosUpdate = true;
                }
            }, 300);
        }
        

// Función para calcular la diferencia
function calcularDiferenciaCotizacion() {
  // Obtener el valor "recibe de esta hipoteca"
  const totalRecibeEl = document.getElementById('desglose-total-recibe');
  // Obtener el total de desembolsos
  const totalDesembolsosEl = document.getElementById('total-desembolsos');
  // Elemento donde se mostrará la diferencia
  const diferenciaEl = document.getElementById('diferencia-cotizacion');
  
  if (totalRecibeEl && totalDesembolsosEl && diferenciaEl) {
    // Extraer valores numéricos (eliminar símbolos de moneda, paréntesis, etc.)
    const extraerValor = (texto) => {
      if (!texto) return 0;
      // Si el formato es (123.45), extraer el número y retornarlo como negativo
      if (texto.startsWith('(') && texto.endsWith(')')) {
        return -parseFloat(texto.substring(1, texto.length - 1).replace(/,/g, ''));
      }
      // Si es un número normal, convertirlo
      return parseFloat(texto.replace(/[^\d.-]/g, ''));
    };
    
    const totalRecibe = extraerValor(totalRecibeEl.textContent);
    const totalDesembolsos = extraerValor(totalDesembolsosEl.textContent);
    const diferencia = totalRecibe - totalDesembolsos;
    
    // Formatear la diferencia para mostrar
    const formatoDiferencia = diferencia.toLocaleString('es-GT', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    
    // Mostrar la diferencia con el signo adecuado
    if (diferencia === 0) {
      diferenciaEl.textContent = '0.00';
      diferenciaEl.classList.remove('text-red-600');
      diferenciaEl.classList.add('text-green-600');
    } else if (diferencia < 0) {
      diferenciaEl.textContent = `(${Math.abs(diferencia).toLocaleString('es-GT', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })})`;
      diferenciaEl.classList.remove('text-green-600');
      diferenciaEl.classList.add('text-red-600');
    } else {
      diferenciaEl.textContent = formatoDiferencia;
      diferenciaEl.classList.remove('text-green-600');
      diferenciaEl.classList.add('text-red-600');
    }
  }
}
        
        // Script principal
        document.addEventListener('DOMContentLoaded', function() {

            // Este evento ya debe existir, añade la siguiente línea dentro de él
  const calculateBtn = document.getElementById('calculate-btn');
  if (calculateBtn) {
    const originalClick = calculateBtn.onclick;
    calculateBtn.onclick = function(e) {
      if (originalClick) originalClick.call(this, e);
      // Ejecutar la función después de calcular la cotización
      setTimeout(calcularDiferenciaCotizacion, 300);
    };
  }

            // Establecer la fecha actual
            const ahora = new Date();
            const fecha = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const fechaFormateada = fecha.toLocaleDateString('es-GT', options);
            
            // Asignar la fecha formateada
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) currentDateElement.textContent = fechaFormateada;
            
            const printFechaElement = document.getElementById('print-fecha');
            if (printFechaElement) printFechaElement.textContent = fechaFormateada;
            
            // Obtener YYYY-MM-DD de manera segura sin problemas de zona horaria
            const año = fecha.getFullYear();
            const mes = String(fecha.getMonth() + 1).padStart(2, '0');
            const día = String(fecha.getDate()).padStart(2, '0');
            const fechaISO = `${año}-${mes}-${día}`;
            
            const fechaFormularioElement = document.getElementById('fecha-formulario');
            if (fechaFormularioElement) fechaFormularioElement.value = fechaISO;
            
            // Inicializar funcionalidades
            initTabs();
            initFormSteps();
            initEventHandlers();
            initGastosManagement();
            initDPIFormat();
            initDesembolsosManagement();
            initFormEventListeners();
            
            

            // Inicializar campos vacíos
            initializeEmptyFields();
            
            // Establecer bandera de cotización calculada
            window.cotizacionCalculada = false;
        
            // Asegurarse de crear las filas de Coopexpress
            createCoopexpressRows();
            
            // Añadir evento para la pestaña de información
            const informationTabButton = document.querySelector('[data-tab="information"]');
            if (informationTabButton) {
                informationTabButton.addEventListener('click', function() {
                    setTimeout(updateInformationTab, 100);
                });
            }
            
            // Añadir evento a empresa para togglear filas de Coopexpress
            const empresaSelect = document.getElementById('empresa');
            if (empresaSelect) {
                empresaSelect.addEventListener('change', toggleCoopexpressExpenses);
            }
        });
        
        // Redefinición completa del objeto FinancialCalculator
        const FinancialCalculator = {
            // Calcular interés del mes en curso con fórmula exacta
            calculateCurrentMonthInterest: function(capital, ratePercentage, fechaActual = new Date()) {
                // Asegurarnos de que la fecha esté normalizada para evitar problemas de zona horaria
                // Crear una nueva fecha usando año, mes, día para eliminar la hora/minutos/segundos
                let fecha = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), fechaActual.getDate());
                
                // Tasa decimal
                const tasaDecimal = ratePercentage / 100;
                
                // Obtener último día del mes
                const ultimoDiaMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
                
                // Calcular diferencia de días como lo haría Excel (incluyendo ambos extremos)
                const fechaMS = fecha.getTime();
                const ultimoDiaMS = ultimoDiaMes.getTime();
                const diffMS = ultimoDiaMS - fechaMS;
                const diasRestantes = Math.floor(diffMS / (1000 * 60 * 60 * 24)) + 1;
                
                // Días totales del mes
                const diasTotalMes = ultimoDiaMes.getDate();
                
                // Aplicar la fórmula exacta que equivale a Excel:
                // ((FIN.MES(fecha,0)-fecha+1) * capital * tasa / días_totales) * -1
                const interesMesCurso = (diasRestantes * capital * tasaDecimal / diasTotalMes) * -1;
                
                // Redondear a 2 decimales como Excel
                return Math.round(interesMesCurso * 100) / 100;
            },
            
            // Calcular interés mensual completo
            calculateMonthlyInterest: function(capital, ratePercentage) {
                return capital * (ratePercentage / 100);
            },
            
            // Calcular gastos basados en porcentajes
            calculateFeeAmount: function(capital, percentage) {
                return capital * (percentage / 100) * -1;
            },
            

            
// Fórmula de registro
calculateRegistro: function(capital, cantidadFincas) {
    let valorBase;
    if (capital < 10000) {
        valorBase = 160;
    } else {
        // Nota: 0.15% es equivalente a 0.0015
        valorBase = (capital - 10000) * 0.0015 + 160;
    }
    
    // En lugar de multiplicar (valorBase + 50) por cantidadFincas,
    // ahora solo sumamos 50 por cada finca adicional
    return -(valorBase + (50 * cantidadFincas));
},
            
// Función corregida
calculateTimbresFiscales: function(valorRGP, valorCatastro, tipoImpuesto) {
    console.log("DENTRO DE calculateTimbresFiscales:");
    console.log("- Valor RGP:", valorRGP);
    console.log("- Valor Catastro:", valorCatastro);
    console.log("- Tipo Impuesto:", tipoImpuesto);
    
    // Asegurarse de que los valores son números válidos
    valorRGP = parseFloat(valorRGP) || 0;
    valorCatastro = parseFloat(valorCatastro) || 0;
    
    // Obtener el máximo entre valorRGP y valorCatastro
    const valorMax = Math.max(valorRGP, valorCatastro);
    console.log("- Valor Máximo:", valorMax);
    
    // Si no hay valores, retornar 0
    if (valorMax <= 0) return 0;
    
    // Determinar porcentaje
    let porcentaje = 0;
    if (tipoImpuesto === 'IVA 12%') {
        porcentaje = 0.12;
    } else if (tipoImpuesto === 'TIMBRE 3%') {
        porcentaje = 0.03;
    } else if (tipoImpuesto === 'N/A') {
        porcentaje = 0;
    }
    console.log("- Porcentaje aplicado:", porcentaje);
    
    // Calcular y retornar como valor negativo
    const resultado = -valorMax * porcentaje;
    console.log("- Resultado del cálculo:", resultado);
    
    return resultado;
},


            // Calcular gastos de inscripción con fórmulas exactas
            calculateRegistrationFees: function(capital, cantidadFincas, valorRGP, valorCatastro, tipoImpuesto) {
    console.log("DENTRO DE calculateRegistrationFees:");
    console.log("- Capital:", capital);
    console.log("- Cantidad Fincas:", cantidadFincas);
    console.log("- Valor RGP:", valorRGP);
    console.log("- Valor Catastro:", valorCatastro);
    console.log("- Tipo Impuesto:", tipoImpuesto);

                     
    const porcentajeLegal = parseFloat(document.getElementById('legal').value) || 0;
const honorarios = capital * (porcentajeLegal / 100) * -1;
    
    // Timbre notarial - valor fijo de -355
    const timbreNotarial = -355;
    
    // Registro según fórmula exacta
    const registro = this.calculateRegistro(capital, cantidadFincas);
    
    // Timbres fiscales con la nueva fórmula
    const timbresFiscales = this.calculateTimbresFiscales(valorRGP, valorCatastro, tipoImpuesto);
    
    // Total de gastos de inscripción
    const total = honorarios + timbreNotarial + registro + timbresFiscales;
    
    return {
        honorarios,
        timbreNotarial,
        registro,
        timbresFiscales,
        total
    };
},
            

calculateFinancialBreakdown: function(params) {
    // Obtener los parámetros de forma segura
    const capital = params.capital;
        const interestRate = params.interestRate;
        const advanceMonths = params.advanceMonths;
        const brokerage = params.brokerage;
        const adminFee = params.adminFee;
        const legalFee = params.legalFee;
        const legalExpenses = params.legalExpenses;
        const otherExpenses = params.otherExpenses;
        const fechaActual = params.fechaActual;
        const cantidadFincas = params.cantidadFincas;
        const valorRGP = params.valorRGP;
        const tipoImpuesto = params.tipoImpuesto;
        const empresa = params.empresa;
        const legalExpensesData = params.legalExpensesData || { total: 0, items: [] };
        const otherExpensesData = params.otherExpensesData || { total: 0, items: [] };
        
    
    // Determinar los gastos específicos de Coopexpress (con signos NEGATIVOS)
    let courierFee = 0;
    let coopFee = 0;
    
    if (empresa === "Coopexpress") {
        courierFee = -75;
        coopFee = -100;
    }

    const valorCatastro = params.valorCatastro || 0;
    
    console.log("DENTRO DE calculateFinancialBreakdown:");
    console.log("- Valor RGP recibido:", params.valorRGP);
    console.log("- Valor Catastro recibido:", valorCatastro);

    
    
    // Interés mensual completo (valor positivo para cálculos internos)
    const monthlyInterest = this.calculateMonthlyInterest(capital, interestRate);
    
    // Interés del mes en curso (valor NEGATIVO)
    const currentMonthInterest = this.calculateCurrentMonthInterest(capital, interestRate, fechaActual);
    
    // Intereses adelantados (valor NEGATIVO)
    const advanceInterest = monthlyInterest * advanceMonths * -1;
    
    // Gastos basados en porcentajes (todos son valores NEGATIVOS)
    const brokerageFee = this.calculateFeeAmount(capital, brokerage);
    const administrationFee = this.calculateFeeAmount(capital, adminFee);
    const legalFeesAmount = this.calculateFeeAmount(capital, legalFee);
    
    // CÁLCULO EXPLÍCITO DEL SUBTOTAL
    // Comenzamos con el capital y luego sumamos todos los gastos (que son valores negativos)
    let subtotal = capital;
        subtotal += currentMonthInterest;  // Suma el interés del mes en curso (negativo)
        subtotal += advanceInterest;       // Suma los intereses adelantados (negativo)
        subtotal += brokerageFee;          // Suma el corretaje (negativo)
        subtotal += administrationFee;     // Suma los gastos administrativos (negativo)
    
    
    // Solo agregar gastos de Coopexpress si corresponde
    if (empresa === "Coopexpress") {
        subtotal += courierFee;        // Suma gastos de courier si aplica (negativo)
        subtotal += coopFee;           // Suma cuota cooperativa si aplica (negativo)
    }
    
    // Mensaje de depuración detallado
    console.log("CÁLCULO DE SUBTOTAL PASO A PASO:");
    console.log("Capital inicial:", capital);
    console.log("+ Intereses del mes en curso:", currentMonthInterest);
    console.log("+ Intereses adelantados:", advanceInterest);
    console.log("+ Corretaje:", brokerageFee);
    console.log("+ Gastos administrativos:", administrationFee);
    
    
    if (empresa === "Coopexpress") {
        console.log("+ Gastos de courier:", courierFee);
        console.log("+ Cuota cooperativa:", coopFee);
    }
    
    console.log("= SUBTOTAL FINAL:", subtotal);
    
    // Gastos de inscripción con fórmulas exactas
    const registrationFees = this.calculateRegistrationFees(capital, cantidadFincas, valorRGP, valorCatastro, tipoImpuesto);
    
    // Total de gastos legales y otros gastos - solo si hay gastos agregados
    const totalLegalExpenses = legalExpenses && legalExpenses > 0 ? -Math.abs(legalExpenses) : 0;
    const totalOtherExpenses = otherExpenses && otherExpenses > 0 ? -Math.abs(otherExpenses) : 0;
    
    // Total de todos los gastos
    const totalExpenses = registrationFees.total + totalLegalExpenses + totalOtherExpenses;
    
    // Monto final a recibir
    const finalAmount = subtotal + totalExpenses;
    
    return {
        capital,
            monthlyInterest,
            currentMonthInterest,
            advanceInterest,
            brokerageFee,
            administrationFee,
            legalFeesAmount,
            courierFee,
            coopFee,
            subtotal,
            registrationFees,
            totalLegalExpenses,
            totalOtherExpenses,
            totalExpenses,
            finalAmount,
            legalExpensesData,    // Agregar los datos completos de gastos legales
            otherExpensesData     // Agregar los datos completos de otros gastos
    };
}
        };

        
        // Función auxiliar para normalizar fechas
        function normalizarFecha(fechaString) {
            // Si es una cadena yyyy-mm-dd, normalizar para evitar problemas de zona horaria
            if (typeof fechaString === 'string' && fechaString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const partes = fechaString.split('-');
                // Crear la fecha usando componentes individuales (año, mes-1, día)
                return new Date(parseInt(partes[0]), parseInt(partes[1])-1, parseInt(partes[2]));
            }
            return new Date(fechaString);
        }
        
        // Funcionalidad de pestañas
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Desactivar todos los botones y contenidos
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Activar el botón y contenido seleccionado
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Si cambia a la pestaña de resumen y no se ha calculado, limpiar campos
                    if (tabId === 'summary' && !window.cotizacionCalculada) {
                        initializeEmptyFields();
                    }
                    
                    // Si cambia a la pestaña de información, actualizar
                    if (tabId === 'information') {
                        setTimeout(() => {
                            updateInformationTab();
                            window.pendingGastosUpdate = false;
                        }, 100);
                    }
                    
                    // Si cambia a la pestaña de resumen, verificar si hay que mostrar gastos Coopexpress
                    if (tabId === 'summary') {
                        toggleCoopexpressExpenses();
                    }
                });
            });
        }
        
        // Navegación del formulario multietapa
        function initFormSteps() {
            const steps = document.querySelectorAll('.form-step');
            const progressSteps = document.querySelectorAll('.progress-step');
            
            // Agregar manejador de clics para los indicadores de paso
            progressSteps.forEach(step => {
                step.addEventListener('click', function() {
                    const stepNumber = parseInt(this.getAttribute('data-step'));
                    goToStep(stepNumber);
                });
            });
            
            // Botones de navegación
            document.getElementById('to-step-2').addEventListener('click', () => {
                goToStep(2);
            });
            
            document.getElementById('to-step-1').addEventListener('click', () => {
                goToStep(1);
            });
            
            document.getElementById('to-step-3').addEventListener('click', () => {
                goToStep(3);
            });
            
            document.getElementById('to-step-2-from-3').addEventListener('click', () => {
                goToStep(2);
            });
            
            document.getElementById('to-step-4').addEventListener('click', () => {
                goToStep(4);
            });
            
            document.getElementById('to-step-3-from-4').addEventListener('click', () => {
                goToStep(3);
            });
            
            function goToStep(stepNumber) {
                // Ocultar todos los pasos
                steps.forEach(step => step.classList.remove('active'));
                
                // Actualizar estados de los indicadores de progreso
                progressSteps.forEach((step, index) => {
                    if (index < stepNumber) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
                
                // Mostrar el paso seleccionado
                steps[stepNumber - 1].classList.add('active');
            }
        }
        
        // Manejadores de eventos
        function initEventHandlers() {
            // Actualizar nombre de empresa en resumen cuando cambie
            document.getElementById('empresa').addEventListener('change', function() {
                document.getElementById('print-empresa').textContent = this.value.toUpperCase();
                document.getElementById('header-empresa').textContent = this.value.toUpperCase();
            });
            
            // Gestión de eliminación de desembolsos
            document.addEventListener('click', function(e) {
                if (e.target.closest('.eliminar-desembolso')) {
                    const row = e.target.closest('tr');
                    const tbody = document.getElementById('desembolsos-container');
                    
                    // Comprobar si es la última fila
                    if (tbody.children.length > 1) {
                        row.remove();
                    } else {
                        // Si es la última fila, solo limpiar los campos
                        const selects = row.querySelectorAll('select');
                        const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                        
                        selects.forEach(select => {
                            select.selectedIndex = 0;
                        });
                        
                        inputs.forEach(input => {
                            input.value = input.type === 'number' ? '0' : '';
                        });
                        
                        alert('Debe haber al menos una fila de desembolso.');
                    }
                }
            });
            
            // Funcionalidad para eliminar hipotecas
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-eliminar-hipoteca')) {
                    const hipotecaElement = e.target.closest('.hipoteca-previa');
                    const hipotecas = document.querySelectorAll('.hipoteca-previa');
                    
                    // No eliminar si solo queda una
                    if (hipotecas.length > 1) {
                        hipotecaElement.remove();
                        
                        // Renumerar las hipotecas restantes
                        document.querySelectorAll('.hipoteca-previa').forEach((el, idx) => {
                            el.querySelector('h3').textContent = `Hipoteca Previa ${idx + 1}`;
                            el.querySelector('.btn-eliminar-hipoteca').disabled = (idx === 0 && document.querySelectorAll('.hipoteca-previa').length === 1);
                        });
                    }
                }
            });
            
            // Cambiar símbolo de moneda cuando cambie la selección
            document.getElementById('moneda').addEventListener('change', function() {
                const simbolo = this.value === 'GTQ' ? 'Q' : '$';
                const simbolosMoneda = document.querySelectorAll('#simbolo-moneda, .input-group-text');
                simbolosMoneda.forEach(el => {
                    el.textContent = simbolo;
                });
            });
            
            // Checkbox para cancelar hipoteca previa
            const cancelaHipoteca = document.getElementById('cancela-hipoteca');
            const hipotecasContainer = document.getElementById('hipotecas-previas-container');
            
            cancelaHipoteca.addEventListener('change', () => {
                hipotecasContainer.style.display = cancelaHipoteca.checked ? 'block' : 'none';
            });
            
            // Botón para agregar hipoteca previa
            document.getElementById('add-hipoteca').addEventListener('click', () => {
                const hipotecasPrevias = document.querySelectorAll('.hipoteca-previa');
                const nuevaHipoteca = hipotecasPrevias[0].cloneNode(true);
                const numHipoteca = hipotecasPrevias.length + 1;
                
                nuevaHipoteca.querySelector('h3').textContent = `Hipoteca Previa ${numHipoteca}`;
                
                // Habilitar botón eliminar
                const btnEliminar = nuevaHipoteca.querySelector('.btn-eliminar-hipoteca');
                btnEliminar.disabled = false;
                
                // Limpiar valores
                const inputs = nuevaHipoteca.querySelectorAll('input');
                inputs.forEach(input => {
                    input.value = '';
                });
                
                document.getElementById('add-hipoteca').before(nuevaHipoteca);
                
                if (document.querySelectorAll('.hipoteca-previa').length > 1) {
                    document.querySelectorAll('.btn-eliminar-hipoteca').forEach(btn => {
                        btn.disabled = false;
                    });
                }
            });
            
            // Botón para agregar desembolso
            document.getElementById('add-desembolso').addEventListener('click', () => {
                addNewDesembolsoRow();
            });
            
            // Botón para calcular cotización
            document.getElementById('calculate-btn').addEventListener('click', () => {
                calculateMortgage();
                window.cotizacionCalculada = true;
                
                // Cambiar a la pestaña de resumen
                document.querySelector('[data-tab="summary"]').click();
            });
            

            
            // Botón para guardar como PDF (real)
document.getElementById('save-pdf-btn').addEventListener('click', (e) => {
    e.preventDefault();
    generarPDF();
});
        }
        
        // Función para aplicar formato al DPI (13 dígitos en formato xxxx xxxxx xxxx)
        function initDPIFormat() {
            const dpiInput = document.getElementById('dpi');
            
            if (dpiInput) {
                // Aplicar máscara al DPI
                dpiInput.addEventListener('input', function(e) {
                    // Obtener solo los dígitos del valor actual
                    const digitsOnly = this.value.replace(/\D/g, '');
                    
                    // Limitar a 13 dígitos
                    const trimmed = digitsOnly.substring(0, 13);
                    
                    // Aplicar formato
                    let formatted = trimmed;
                    if (trimmed.length > 4) {
                        formatted = trimmed.substring(0, 4) + " " + trimmed.substring(4);
                    }
                    if (trimmed.length > 9) {
                        formatted = formatted.substring(0, 10) + " " + formatted.substring(10);
                    }
                    
                    // Asignar el valor formateado
                    this.value = formatted;
                });
                
// Validar al perder el foco
dpiInput.addEventListener('blur', function() {
    const digitsOnly = this.value.replace(/\D/g, '');
    if (digitsOnly.length > 0 && digitsOnly.length < 13) {
        mostrarAlertaDPI('El DPI debe tener exactamente 13 dígitos');
        // No es necesario llamar a this.focus() aquí, ya que
        // la función mostrarAlertaDPI lo hará automáticamente al cerrar
    }
});
            }
        }
        
        // Función para mostrar una alerta personalizada que sí se cierra correctamente
function mostrarAlertaDPI(mensaje) {
    // Crear el contenedor de la alerta
    const alerta = document.createElement('div');
    alerta.style.position = 'fixed';
    alerta.style.top = '0';
    alerta.style.left = '0';
    alerta.style.width = '100%';
    alerta.style.height = '100%';
    alerta.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    alerta.style.display = 'flex';
    alerta.style.alignItems = 'center';
    alerta.style.justifyContent = 'center';
    alerta.style.zIndex = '9999';
    
    // Crear el contenido de la alerta
    const contenido = document.createElement('div');
    contenido.style.backgroundColor = '#222';
    contenido.style.color = 'white';
    contenido.style.padding = '20px';
    contenido.style.borderRadius = '8px';
    contenido.style.maxWidth = '90%';
    contenido.style.width = '400px';
    contenido.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    
    // Título de la alerta
    const titulo = document.createElement('h3');
    titulo.textContent = 'Esta página dice';
    titulo.style.marginTop = '0';
    titulo.style.fontSize = '18px';
    titulo.style.fontWeight = 'normal';
    titulo.style.color = 'white';
    titulo.style.marginBottom = '15px';
    
    // Mensaje de la alerta
    const mensajeElement = document.createElement('p');
    mensajeElement.textContent = mensaje;
    mensajeElement.style.marginBottom = '20px';
    
    // Botón Aceptar
    const boton = document.createElement('button');
    boton.textContent = 'Aceptar';
    boton.style.backgroundColor = '#4B50E6';
    boton.style.color = 'white';
    boton.style.border = 'none';
    boton.style.padding = '8px 16px';
    boton.style.borderRadius = '20px';
    boton.style.cursor = 'pointer';
    boton.style.float = 'right';
    
    // Agregar evento de clic al botón para cerrar la alerta
    boton.addEventListener('click', function() {
        document.body.removeChild(alerta);
        // Enfocar de nuevo el campo DPI
        const dpiInput = document.getElementById('dpi');
        if (dpiInput) dpiInput.focus();
    });
    
    // Armar la alerta
    contenido.appendChild(titulo);
    contenido.appendChild(mensajeElement);
    contenido.appendChild(boton);
    alerta.appendChild(contenido);
    
    // Mostrar la alerta
    document.body.appendChild(alerta);
}

        // Función para actualizar la pestaña de información
        function updateInformationTab() {
            // Obtener valores del formulario con verificación de nulos
            const fechaField = document.getElementById('fecha-formulario');
            const tipoSolicitudField = document.getElementById('tipo-solicitud');
            const empresaField = document.getElementById('empresa');
            const monedaField = document.getElementById('moneda');
            const tipoPrestamoField = document.getElementById('tipo-prestamo');
            const clienteField = document.getElementById('cliente');
            const dpiField = document.getElementById('dpi');
            const nitField = document.getElementById('nit');
            const asesorField = document.getElementById('asesor');
            const capitalField = document.getElementById('capital');
            const interesField = document.getElementById('interes');
            const corretajeField = document.getElementById('corretaje');
            const gastosAdminField = document.getElementById('gastos-admin');
            const legalField = document.getElementById('legal');
            const mesesAdelantarField = document.getElementById('meses-adelantar');
            const cantidadFincasField = document.getElementById('cantidad-fincas');
            const tipoImpuestoField = document.getElementById('tipo-impuesto');
            const valorRgpField = document.getElementById('valor-rgp');
            const valorCatastroField = document.getElementById('valor-catastro');
            
            // Obtener el símbolo de moneda
            const moneda = monedaField?.value || 'GTQ';
            const simboloMoneda = moneda === 'GTQ' ? 'Q' : '$';
            
            // Fecha actual si no hay fecha en el formulario
            let fechaActual = new Date();
            if (fechaField && fechaField.value) {
                fechaActual = new Date(fechaField.value);
            }
            
            // Formatear la fecha para mostrar
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            const fechaFormateada = fechaActual.toLocaleDateString('es-GT', opciones);
            
            // Verificar y asignar elementos de información
            const infoFecha = document.getElementById('info-fecha');
    if (infoFecha) infoFecha.textContent = fechaFormateada;
    
    // Obtener el número del mes actual para mostrar
    const numeroMes = fechaActual.getMonth() + 1;
  
    // Asignar todos los valores a los elementos correspondientes
    setInfoText('info-tipo-solicitud', tipoSolicitudField?.value || '');
    setInfoText('info-empresa', empresaField?.value || '');
    setInfoText('info-moneda', monedaField?.value === 'GTQ' ? 'Quetzales' : 'Dólares');
    setInfoText('info-tipo-prestamo', tipoPrestamoField?.value || '');
    setInfoText('info-mes', numeroMes);
    setInfoText('info-cliente', clienteField?.value || '');
    setInfoText('info-dpi', dpiField?.value || '');
    setInfoText('info-nit', nitField?.value || '');
    setInfoText('info-asesor', asesorField?.options[asesorField?.selectedIndex]?.text || '');
    setInfoText('info-capital', formatNumber(parseFloat(capitalField?.value) || 0));
    setInfoText('info-interes', `${(parseFloat(interesField?.value) || 0).toFixed(2)}%`);
    setInfoText('info-corretaje', `${(parseFloat(corretajeField?.value) || 0).toFixed(2)}%`);
    setInfoText('info-gasto-admin', `${(parseFloat(gastosAdminField?.value) || 0).toFixed(2)}%`);
    setInfoText('info-legal', `${(parseFloat(legalField?.value) || 0).toFixed(2)}%`);
    setInfoText('info-meses-adelantar', mesesAdelantarField?.value || '0');
    setInfoText('info-cantidad-fincas', cantidadFincasField?.value || '0');
    setInfoText('info-tipo-impuesto', tipoImpuestoField?.value || '');
    setInfoText('info-valor-rgp', formatNumber(parseFloat(valorRgpField?.value) || 0));
    setInfoText('info-valor-catastro', formatNumber(parseFloat(valorCatastroField?.value) || 0));
    
    // Establecer símbolos de moneda
    const simbolosMoneda = document.querySelectorAll('#info-moneda-simbolo, #info-moneda-simbolo2, #info-moneda-simbolo3');
    simbolosMoneda.forEach(el => {
        if (el) el.textContent = simboloMoneda;
    });
    
    // Actualizar título de tipo de préstamo
    const tipoPrestamoDom = document.getElementById('info-tipo-prestamo-titulo');
    if (tipoPrestamoDom && tipoPrestamoField) {
        tipoPrestamoDom.textContent = tipoPrestamoField.value.toUpperCase();
    }
    
    // Actualizar sección de hipotecas previas
    updateInfoHipotecas(simboloMoneda);
    
    // Función auxiliar para establecer texto en elementos
    function setInfoText(id, value) {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    }
    
    // Actualizar tabla de gastos
    updateGastosInfoTable();
}

// Función para actualizar la sección de hipotecas previas en la pestaña de información
function updateInfoHipotecas(simboloMoneda) {
    const container = document.getElementById('info-hipotecas-container');
    if (!container) return;
    
    // Limpiar el contenedor actual
    container.innerHTML = '';
    
    // Verificar si se cancelan hipotecas
    const cancelaHipoteca = document.getElementById('cancela-hipoteca').checked;
    
    if (!cancelaHipoteca) {
        const noHipotecas = document.createElement('div');
        noHipotecas.className = 'text-gray-500 text-center py-4';
        noHipotecas.textContent = 'No se cancelan hipotecas previas';
        container.appendChild(noHipotecas);
        return;
    }
    
    // Obtener todas las hipotecas previas
    const hipotecas = document.querySelectorAll('.hipoteca-previa');
    
    hipotecas.forEach((hipoteca, index) => {
        const montoInput = hipoteca.querySelector('[name="monto-hipoteca"]');
        const acreedorInput = hipoteca.querySelector('[name="acreedor"]');
        const montoCTPInput = hipoteca.querySelector('[name="monto-ctp"]');
        
        const monto = parseFloat(montoInput?.value) || 0;
        const acreedor = acreedorInput?.value || '';
        const montoCTP = parseFloat(montoCTPInput?.value) || 0;
        
        if (monto > 0 || acreedor || montoCTP > 0) {
            const hipotecaInfo = document.createElement('div');
            hipotecaInfo.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-3 border border-gray-300 rounded-lg bg-gray-50';
            
            hipotecaInfo.innerHTML = `
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500">Hipoteca ${index + 1} - Monto</label>
                    <div class="flex items-center">
                        <span class="px-2 py-1 bg-gray-200 border border-gray-300 border-r-0">${simboloMoneda}</span>
                        <div class="flex-grow border border-gray-300 p-2 bg-white">${formatNumber(monto)}</div>
                    </div>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500">Acreedor</label>
                    <div class="border border-gray-300 p-2 bg-white">${acreedor}</div>
                </div>
                <div class="flex flex-col">
                    <label class="text-xs text-gray-500">Monto CTP</label>
                    <div class="flex items-center">
                        <span class="px-2 py-1 bg-gray-200 border border-gray-300 border-r-0">${simboloMoneda}</span>
                        <div class="flex-grow border border-gray-300 p-2 bg-white">${formatNumber(montoCTP)}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(hipotecaInfo);
        }
    });
    
    // Si no se agregó ninguna hipoteca válida
    if (container.children.length === 0) {
        const noHipotecas = document.createElement('div');
        noHipotecas.className = 'text-gray-500 text-center py-4';
        noHipotecas.textContent = 'Se cancelan hipotecas pero no se han agregado detalles';
        container.appendChild(noHipotecas);
    }
}

// Función para actualizar la tabla de gastos en la pestaña de información
function updateGastosInfoTable() {
    // Esta función puede usar los datos de gastosStore para actualizar la tabla
    // Esto ya está implementado en gastosStore.renderInfoTable()
    if (typeof gastosStore !== 'undefined' && gastosStore.renderInfoTable) {
        gastosStore.renderInfoTable();
    }
}

// Almacén global de gastos
const gastosStore = {
    items: [],
    
    // Añadir un nuevo gasto
    addGasto: function(tipo, cantidad, honorario, reembolso, retenido, reemborsoCTP) {
        const id = Date.now(); // ID único basado en timestamp
        
        // Total es la suma de todos los valores (sin multiplicar por cantidad)
        const total = honorario + reembolso + retenido + reemborsoCTP;
        
        const gasto = {
            id,
            tipo,
            cantidad,
            honorario: honorario,
            reembolso: reembolso,
            retenido: retenido,
            reemborsoCTP: reemborsoCTP,
            total: total
        };
        
        this.items.push(gasto);
        this.renderAll();
        return id;
    },
    
    // Eliminar un gasto por su ID
    removeGasto: function(id) {
        this.items = this.items.filter(item => item.id !== id);
        this.renderAll();
    },
    
    // Renderizar en todos los lugares necesarios
    renderAll: function() {
        this.renderFormTable();
        this.renderVisualPanel();
        this.renderInfoTable();
    },
    
    // Renderizar en la tabla del formulario
    renderFormTable: function() {
        const table = document.getElementById('gastos-legales-table');
        if (!table) return;
        
        table.innerHTML = '';
        
        this.items.forEach((gasto, index) => {
            const row = document.createElement('tr');
            
            // Función para formatear valores (mostrar guion si es cero)
            const formatValue = (value) => {
                return value === 0 ? '-' : value.toFixed(2);
            };
            
            // Calcular el total multiplicado por cantidad
            const totalCalculado = (gasto.honorario + gasto.reembolso + gasto.retenido + gasto.reemborsoCTP) * gasto.cantidad;
            
            row.innerHTML = `
                <td class="px-4 py-2">${index + 1}</td>
                <td class="px-4 py-2">${gasto.tipo}</td>
                <td class="px-4 py-2">${gasto.cantidad}</td>
                <td class="px-4 py-2">${formatValue(gasto.honorario)}</td>
                <td class="px-4 py-2">${formatValue(gasto.reembolso)}</td>
                <td class="px-4 py-2">${formatValue(gasto.retenido)}</td>
                <td class="px-4 py-2">${formatValue(gasto.reemborsoCTP)}</td>
                <td class="px-4 py-2">${formatValue(totalCalculado)}</td>
                <td class="px-4 py-2">
                    <button class="eliminar-gasto text-red-500 hover:text-red-700" data-gasto-id="${gasto.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            table.appendChild(row);
        });
        
        this.updateTotales();
    },
    
    // Renderizar en el panel visual
    renderVisualPanel: function() {
        const panel = document.getElementById('lista-gastos-legales');
        if (!panel) return;
        
        // Limpiar panel excepto mensaje de "no hay gastos"
        const noGastosMsg = document.getElementById('no-gastos-legales');
        panel.innerHTML = '';
        if (noGastosMsg) panel.appendChild(noGastosMsg);
        
        if (this.items.length === 0) {
            if (noGastosMsg) noGastosMsg.style.display = 'block';
            return;
        }
        
        if (noGastosMsg) noGastosMsg.style.display = 'none';
        
        this.items.forEach((gasto) => {
            const gastoItem = document.createElement('div');
            gastoItem.className = 'flex justify-between items-center p-2 mb-2 bg-white border rounded';
            
            // Calcular el total multiplicado por cantidad (solo para visualización)
            const totalCalculado = (gasto.honorario + gasto.reembolso + gasto.retenido + gasto.reemborsoCTP) * gasto.cantidad;
            
            // Nuevo formato de visualización
            let contenidoHTML = `
                <div>
                    <p class="font-medium">${gasto.tipo}</p>
                    <p class="text-sm text-gray-600">
                        Costo: Q ${(gasto.honorario + gasto.reembolso + gasto.retenido + gasto.reemborsoCTP).toFixed(2)} × ${gasto.cantidad}
            `;
            
            // Siempre mostrar el total si la cantidad es mayor que 1
            if (gasto.cantidad > 1) {
                contenidoHTML += ` = Total: Q ${totalCalculado.toLocaleString('es-GT', {minimumFractionDigits: 2})}`;
            }
            
            contenidoHTML += `
                    </p>
                </div>
                <button class="eliminar-gasto-visual text-red-500 hover:text-red-700" data-gasto-id="${gasto.id}">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            gastoItem.innerHTML = contenidoHTML;
            
            panel.appendChild(gastoItem);
        });
    },
    
    // Renderizar en la tabla de información
    renderInfoTable: function() {
        const table = document.getElementById('info-gastos-table');
        if (!table) return; // Si la tabla no existe (pestaña no visible), no hacer nada
        
        table.innerHTML = '';
        
        this.items.forEach((gasto, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-2">${index + 1}</td>
                <td class="px-4 py-2">${gasto.tipo}</td>
                <td class="px-4 py-2">${gasto.cantidad}</td>
                <td class="px-4 py-2">${gasto.honorario.toFixed(2)}</td>
                <td class="px-4 py-2">${gasto.reembolso.toFixed(2)}</td>
                <td class="px-4 py-2">${gasto.retenido.toFixed(2)}</td>
                <td class="px-4 py-2">${gasto.reemborsoCTP.toFixed(2)}</td>
                <td class="px-4 py-2">${gasto.total.toFixed(2)}</td>
            `;
            table.appendChild(row);
        });
        
        this.updateInfoTotales();
    },
    
    // Actualizar totales en el formulario
    updateTotales: function() {
        let totalHonorarios = 0;
        let totalReembolso = 0;
        let totalRetenido = 0;
        let totalReemborsoCTP = 0;
        
        this.items.forEach(gasto => {
            totalHonorarios += gasto.honorario;
            totalReembolso += gasto.reembolso;
            totalRetenido += gasto.retenido;
            totalReemborsoCTP += gasto.reemborsoCTP;
        });
        
        // Actualizar elementos si existen
        const elementos = {
            'total-honorarios-table': totalHonorarios,
            'total-reembolso-table': totalReembolso,
            'total-retenido-table': totalRetenido,
            'total-reembolso-ctp-table': totalReemborsoCTP,
        };
        
        for (const [id, valor] of Object.entries(elementos)) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor > 0 ? valor.toFixed(2) : '-';
            }
        }
        
        // Actualizar valor a reembolsar a legal (suma de Reembolso + Reembolso CTP)
        const valorReembolsarElement = document.getElementById('valor-reembolsar-legal');
        if (valorReembolsarElement) {
            const valorReembolsar = totalReembolso + totalReemborsoCTP;
            valorReembolsarElement.textContent = valorReembolsar > 0 ? valorReembolsar.toFixed(2) : '0.00';
        }
    },
    
    // Actualizar totales en la tabla de información
    updateInfoTotales: function() {
        let totalHonorarios = 0;
        let totalReembolso = 0;
        let totalRetenido = 0;
        let totalReemborsoCTP = 0;
        let totalTotal = 0;
        
        this.items.forEach(gasto => {
            const cantidad = gasto.cantidad || 1;
            totalHonorarios += gasto.honorario * cantidad;
            totalReembolso += gasto.reembolso * cantidad;
            totalRetenido += gasto.retenido * cantidad;
            totalReemborsoCTP += gasto.reemborsoCTP * cantidad;
            totalTotal += gasto.total * cantidad;
        });
        
        // Actualizar elementos si existen
        const elementos = {
            'total-honorarios-table': totalHonorarios,
            'total-reembolso-table': totalReembolso,
            'total-retenido-table': totalRetenido,
            'total-reembolso-ctp-table': totalReemborsoCTP,
            'total-gastos-table': totalTotal
        };
        
        for (const [id, valor] of Object.entries(elementos)) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = valor > 0 ? valor.toFixed(2) : '0.00';
            }
        }
    }
};

// Función para manejar la gestión de gastos legales
function initGastosManagement() {
    // Gastos Legales
    document.getElementById('agregar-gasto-legal').addEventListener('click', function() {
    const selectGasto = document.getElementById('select-gasto-legal');
    const selectedOption = selectGasto.options[selectGasto.selectedIndex];
    const cantidad = parseInt(document.getElementById('gasto-legal-cantidad').value) || 1;
    
    if (selectGasto.value === "") return;
    
    // Obtener los valores de atributos data
    const honorario = parseFloat(selectedOption.getAttribute('data-honorario')) || 0;
    const reembolso = parseFloat(selectedOption.getAttribute('data-reembolso')) || 0;
    const retenido = parseFloat(selectedOption.getAttribute('data-retenido')) || 0;
    
    // Calcular reembolso CTP solo si el gasto es "Carta Total de Pago"
    let reemborsoCTP = 0;
    if (selectedOption.text === "Carta Total de Pago") {
        // Sumar todos los montos CTP de las hipotecas previas
        reemborsoCTP = calcularTotalMontosCTP();
    } else {
        // Si no es Carta Total de Pago, usar el valor del data-attribute
        reemborsoCTP = parseFloat(selectedOption.getAttribute('data-reembolso-ctp')) || 0;
    }
    
    // Usar el almacén de datos global para añadir el gasto
    gastosStore.addGasto(
        selectedOption.text,
        cantidad,
        honorario,
        reembolso,
        retenido,
        reemborsoCTP
    );
    
    // Resetear campos
    selectGasto.value = "";
    document.getElementById('gasto-legal-cantidad').value = "1";
});


// Función para calcular el total de montos CTP de todas las hipotecas previas
function calcularTotalMontosCTP() {
    // Verificar primero si se está cancelando hipoteca
    const cancelaHipoteca = document.getElementById('cancela-hipoteca').checked;
    if (!cancelaHipoteca) return 0;
    
    // Obtener todas las hipotecas previas
    const hipotecas = document.querySelectorAll('.hipoteca-previa');
    let totalCTP = 0;
    
    // Sumar los montos CTP de cada hipoteca
    hipotecas.forEach(hipoteca => {
        const montoCTPInput = hipoteca.querySelector('[name="monto-ctp"]');
        if (montoCTPInput) {
            const montoCTP = parseFloat(montoCTPInput.value) || 0;
            totalCTP += montoCTP;
        }
    });
    
    console.log("Total de montos CTP sumados:", totalCTP);
    return totalCTP;
}




function initCTPEvents() {
    // Delegación de eventos para los inputs de monto CTP
    document.addEventListener('input', function(e) {
        if (e.target.name === 'monto-ctp') {
            // Buscar todos los gastos de tipo "Carta Total de Pago" y actualizar su reembolso CTP
            actualizarReembolsoCTPEnGastos();
        }
    });
    
    // También detectar cuando se agrega o elimina una hipoteca
    document.getElementById('add-hipoteca').addEventListener('click', function() {
        setTimeout(actualizarReembolsoCTPEnGastos, 100);
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-eliminar-hipoteca')) {
            setTimeout(actualizarReembolsoCTPEnGastos, 100);
        }
    });
}

function actualizarReembolsoCTPEnGastos() {
    // Calcular el total de montos CTP
    const totalCTP = calcularTotalMontosCTP();
    
    // Actualizar todos los gastos de tipo "Carta Total de Pago"
    const itemsActualizados = [];
    gastosStore.items.forEach(gasto => {
        if (gasto.tipo === "Carta Total de Pago") {
            // Guardar el ID y el reembolso CTP anterior para depuración
            itemsActualizados.push({
                id: gasto.id,
                reemborsoCTPAnterior: gasto.reemborsoCTP,
                reemborsoCTPNuevo: totalCTP
            });
            
            // Actualizar el reembolso CTP
            gasto.reemborsoCTP = totalCTP;
            // Actualizar el total
            gasto.total = gasto.honorario + gasto.reembolso + gasto.retenido + gasto.reemborsoCTP;
        }
    });
    
    // Si se actualizó algún gasto, renderizar nuevamente
    if (itemsActualizados.length > 0) {
        console.log("Gastos actualizados:", itemsActualizados);
        gastosStore.renderAll();
    }
}

    // Otros Gastos
    document.getElementById('agregar-otro-gasto').addEventListener('click', function() {
        const selectGasto = document.getElementById('select-otro-gasto');
        const costoInput = document.getElementById('otro-gasto-costo');
        
        if(selectGasto.value === "") {
            return; // No hacer nada si no hay selección
        }
        
        // Obtener el costo personalizado
        const costo = parseFloat(costoInput.value) || 0;
        
        // Ocultar mensaje de "no hay gastos"
        if(document.getElementById('no-otros-gastos')) {
            document.getElementById('no-otros-gastos').style.display = 'none';
        }
        
        // Crear el elemento de gasto
        const gastoItem = document.createElement('div');
        gastoItem.className = 'flex justify-between items-center p-2 mb-2 bg-white border rounded';
        
        gastoItem.innerHTML = `
            <div>
                <p class="font-medium">${selectGasto.value}</p>
                <p class="text-sm text-gray-600">Costo: Q ${costo.toFixed(2)}</p>
                <input type="hidden" class="otro-gasto-value" value="${selectGasto.value}">
                <input type="hidden" class="otro-gasto-cost" value="${costo}">
            </div>
            <button class="eliminar-otro-gasto text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        // Añadir a la lista
        document.getElementById('lista-otros-gastos').appendChild(gastoItem);
        
        // Resetear los campos
        selectGasto.value = "";
        costoInput.value = "0";
    });
    
    // Delegación de eventos para eliminar gastos
    document.addEventListener('click', function(e) {
        if(e.target.closest('.eliminar-gasto')) {
            const gastoId = parseInt(e.target.closest('.eliminar-gasto').dataset.gastoId);
            if (gastoId) {
                gastosStore.removeGasto(gastoId);
            }
        }
        
        if(e.target.closest('.eliminar-gasto-visual')) {
            const gastoId = parseInt(e.target.closest('.eliminar-gasto-visual').dataset.gastoId);
            if (gastoId) {
                gastosStore.removeGasto(gastoId);
            }
        }
        
        // Para otros gastos
        if(e.target.closest('.eliminar-otro-gasto')) {
            const gastoItem = e.target.closest('div.flex');
            if (gastoItem) {
                gastoItem.remove();
                
                // Mostrar mensaje si no hay gastos
                if(document.getElementById('lista-otros-gastos').children.length === 1) {
                    document.getElementById('no-otros-gastos').style.display = 'block';
                }
            }
        }
    });
}

// Función para inicializar la gestión de desembolsos
function initDesembolsosManagement() {
    // Establecer evento para el botón de agregar desembolso
    const addDesembolsoBtn = document.getElementById('add-desembolso');
    if (addDesembolsoBtn) {
        addDesembolsoBtn.addEventListener('click', function() {
            addNewDesembolsoRow();
        });
    }
}

// Función para agregar una nueva fila de desembolso
function addNewDesembolsoRow() {
    const tbody = document.getElementById('desembolsos-container');
    if (!tbody) return;
    
    const newRow = document.createElement('tr');
    
    // Obtener la moneda actual
    const moneda = document.getElementById('moneda');
    const simbolo = moneda && moneda.value === 'GTQ' ? 'Q' : '$';
    
    // Crear la nueva fila con todos los campos necesarios
    newRow.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <select class="input-field w-full">
                <option value="">Seleccione...</option>
                <option value="Desembolso 1">Desembolso 1</option>
                <option value="Desembolso 2">Desembolso 2</option>
                <option value="Desembolso 3">Desembolso 3</option>
                <option value="Desembolso 4">Desembolso 4</option>
                <option value="Desembolso 5">Desembolso 5</option>
                <option value="Desembolso 6">Desembolso 6</option>
                <option value="Compraventa">Compraventa</option>
                <option value="Pago de Hipoteca 1">Pago de Hipoteca 1</option>
                <option value="Pago de Hipoteca 2">Pago de Hipoteca 2</option>
            </select>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <input type="text" class="input-field w-full" placeholder="Beneficiario">
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="input-group">
                <span class="input-group-text">${simbolo}</span>
                <input type="number" class="input-field w-32" value="0">
            </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <select class="input-field w-full mr-2">
                    <option value="">Seleccione...</option>
                    <option value="Cheque para el Cliente">Cheque para el Cliente</option>
                    <option value="Acreedor Hipotecario">Acreedor Hipotecario</option>
                    <option value="Ret. Por IUSI">Ret. Por IUSI</option>
                    <option value="Ret. Por Nomenclatura">Ret. Por Nomenclatura</option>
                </select>
                <button class="eliminar-desembolso text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    tbody.appendChild(newRow);
}
// FUNCIONES PARA LA PESTAÑA DE RESUMEN (CORREGIDAS)

// Función para inicializar todos los campos del resumen con valores vacíos
function initializeEmptyFields() {
    // 1. Limpiar datos de cliente
    const clienteFields = [
        'print-empresa', 'print-cliente', 'print-dpi', 'print-nit', 
        'print-tipo-prestamo', 'print-interes', 'print-interes-mensual',
        'print-meses-adelantados', 'print-corretaje', 'print-gastos-admin', 'print-legal'
    ];
    
    clienteFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = '';
    });
    
    // 2. Limpiar desglose financiero
    const desgloseFields = [
        'desglose-monto', 'desglose-intereses-mes', 'desglose-intereses-adelantados', 
        'desglose-corretaje', 'desglose-gastos-admin', 'desglose-subtotal',
        'desglose-gastos-inscripcion', 'desglose-honorarios', 'desglose-timbre',
        'desglose-registro', 'desglose-timbres', 'desglose-otros-gastos-legales',
        'desglose-otros-gastos', 'desglose-total-gastos', 'desglose-total-recibe'
    ];
    
    desgloseFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = '';
    });
    
// Observador para recalcular cuando cambie el contenido de desembolsos
const desembolsosPrint = document.getElementById('desembolsos-print');
  if (desembolsosPrint) {
    const observer = new MutationObserver(calcularDiferenciaCotizacion);
    observer.observe(desembolsosPrint, { childList: true, subtree: true });
  }


    
}


// Agregar esta función independiente para calcular el subtotal
function calculateSubtotalDirectly() {
    // Obtener todos los valores relevantes
    const capital = parseFloat(document.getElementById('capital').value) || 0;
    const interes = parseFloat(document.getElementById('interes').value) || 0;
    const mesesAdelantar = parseInt(document.getElementById('meses-adelantar').value) || 0;
    const corretaje = parseFloat(document.getElementById('corretaje').value) || 0;
    const gastosAdmin = parseFloat(document.getElementById('gastos-admin').value) || 0;
    const legal = parseFloat(document.getElementById('legal').value) || 0;
    const empresa = document.getElementById('empresa').value;
    
    // Obtener la fecha actual
    const fechaFormulario = document.getElementById('fecha-formulario').value;
    let fechaActual;
    if (fechaFormulario) {
        fechaActual = normalizarFecha(fechaFormulario);
    } else {
        fechaActual = new Date();
    }
    
    // Calcular interés mensual
    const interesDecimal = interes / 100;
    const interesMonetario = capital * interesDecimal;
    
    // Calcular interés del mes en curso (fórmula como en Excel)
    const ultimoDiaMes = new Date(fechaActual.getFullYear(), fechaActual.getMonth() + 1, 0);
    const diasRestantes = ultimoDiaMes.getDate() - fechaActual.getDate() + 1;
    const diasTotalMes = ultimoDiaMes.getDate();
    const interesesMes = -(diasRestantes * capital * interesDecimal / diasTotalMes);
    
    // Calcular intereses adelantados
    const interesesAdelantados = -interesMonetario * mesesAdelantar;
    
    // Calcular gastos basados en porcentajes
    const gastoCorretaje = -(capital * corretaje / 100);
    const gastoAdmin = -(capital * gastosAdmin / 100);
    const gastoLegal = -(capital * legal / 100);
    
    // Determinar gastos específicos de Coopexpress
    let gastoCourier = 0;
    let gastoCooperativa = 0;
    if (empresa === "Coopexpress") {
        gastoCourier = -75;
        gastoCooperativa = -100;
    }
    
    // Calcular subtotal
    const subtotal = capital + 
                     interesesMes + 
                     interesesAdelantados + 
                     gastoCorretaje + 
                     gastoAdmin +  
                     gastoCourier + 
                     gastoCooperativa;
    
    console.log("Cálculo directo del subtotal:");
    console.log("- Capital:", capital);
    console.log("- Intereses mes curso:", interesesMes);
    console.log("- Intereses adelantados:", interesesAdelantados);
    console.log("- Corretaje:", gastoCorretaje);
    console.log("- Gastos admin:", gastoAdmin);
    console.log("- Gastos legal:", gastoLegal);
    console.log("- Courier:", gastoCourier);
    console.log("- Cooperativa:", gastoCooperativa);
    console.log("= Subtotal calculado directamente:", subtotal);
    
    return subtotal;
}


// Función principal para calcular la hipoteca (corregida)
function calculateMortgage() {
    // Obtener valores del formulario
    const cliente = document.getElementById('cliente').value;
    const dpi = document.getElementById('dpi').value;
    const nit = document.getElementById('nit').value;
    const tipoPrestamo = document.getElementById('tipo-prestamo').value;
    const empresa = document.getElementById('empresa').value;
    
    // Obtener y normalizar fecha
    const fechaFormulario = document.getElementById('fecha-formulario').value;
    let fechaActual;
    
    if (fechaFormulario) {
        fechaActual = normalizarFecha(fechaFormulario);
    } else {
        fechaActual = new Date();
    }
    
    const gastosLegalesData = collectLegalExpenses();
const otrosGastosData = collectOtherExpenses();

console.log("Datos de gastos para la cotización:");
console.log("- Gastos legales:", gastosLegalesData);
console.log("- Otros gastos:", otrosGastosData);

    // Obtener valores financieros
    const monedaSelect = document.getElementById('moneda');
    const moneda = monedaSelect.value;
    const simboloMoneda = moneda === 'GTQ' ? 'Q' : '$';
    const capital = parseFloat(document.getElementById('capital').value) || 0;
    const interes = parseFloat(document.getElementById('interes').value) || 0;
    const corretaje = parseFloat(document.getElementById('corretaje').value) || 0;
    const gastosAdmin = parseFloat(document.getElementById('gastos-admin').value) || 0;
    const legal = parseFloat(document.getElementById('legal').value) || 0;
    const mesesAdelantar = parseInt(document.getElementById('meses-adelantar').value) || 0;
    
    // Obtener valores específicos para cálculos exactos
    const tipoImpuesto = document.getElementById('tipo-impuesto').value;
    const cantidadFincas = parseInt(document.getElementById('cantidad-fincas').value) || 1;
    const valorRGP = parseFloat(document.getElementById('valor-rgp').value) || 0;
    const valorCatastro = parseFloat(document.getElementById('valor-catastro').value) || 0;
    
// Verificar los valores para debugging
    console.log("VALORES CAPTURADOS PARA CÁLCULO:");
    console.log("- Valor RGP:", valorRGP);
    console.log("- Valor Catastro:", valorCatastro);
    console.log("- Tipo de impuesto:", tipoImpuesto);

    // Verificar si hay datos mínimos necesarios
    if (!cliente || !capital) {
        alert("Por favor ingrese al menos el nombre del cliente y el capital solicitado.");
        return;
    }
    
    // Recopilar gastos legales y otros gastos de manera más precisa
    const gastosLegales = collectLegalExpenses();
    const otrosGastos = collectOtherExpenses();

console.log("Totales de gastos para la cotización:");
console.log("- Gastos legales:", gastosLegales);
console.log("- Otros gastos:", otrosGastos);
    
    // Calcular el desglose financiero completo con todos los parámetros
    const breakdown = FinancialCalculator.calculateFinancialBreakdown({
        capital,
        interestRate: interes,
        advanceMonths: mesesAdelantar,
        brokerage: corretaje,
        adminFee: gastosAdmin,
        legalFee: legal,
        legalExpensesData: gastosLegalesData,   // Pasar el objeto completo
        otherExpensesData: otrosGastosData,     // Pasar el objeto completo
        legalExpenses: gastosLegalesData.total, // Mantener compatibilidad
        otherExpenses: otrosGastosData.total,   // Mantener compatibilidad
        fechaActual,
        cantidadFincas,
        valorRGP,
        valorCatastro,  // Esta línea debe existir y tener el valor correcto
        tipoImpuesto,
        empresa
    });
    
    
    // Actualizar datos del cliente en la pestaña de resumen
    if (empresa) document.getElementById('print-empresa').textContent = empresa;
    if (cliente) document.getElementById('print-cliente').textContent = cliente;
    if (dpi) document.getElementById('print-dpi').textContent = dpi;
    if (nit) document.getElementById('print-nit').textContent = nit;
    if (tipoPrestamo) document.getElementById('print-tipo-prestamo').textContent = tipoPrestamo;
    
    // Actualizar valores financieros
    if (interes) document.getElementById('print-interes').textContent = interes.toFixed(2) + '%';
    
    // Calcular y mostrar el interés mensual como valor monetario (directamente)
    const interesMonetario = capital * (interes / 100);
    document.getElementById('print-interes-mensual').textContent = `${simboloMoneda} ${formatNumber(interesMonetario)}`;
    
    if (mesesAdelantar !== undefined) document.getElementById('print-meses-adelantados').textContent = mesesAdelantar;
    if (corretaje) document.getElementById('print-corretaje').textContent = corretaje.toFixed(2) + '%';
    if (gastosAdmin) document.getElementById('print-gastos-admin').textContent = gastosAdmin.toFixed(2) + '%';
    if (legal) document.getElementById('print-legal').textContent = legal.toFixed(2) + '%';
    
 // Antes de actualizar la tabla, verificar el subtotal calculado directamente
 const subtotalDirecto = calculateSubtotalDirectly();
    console.log("Subtotal calculado directamente:", subtotalDirecto);
    console.log("Subtotal desde FinancialCalculator:", breakdown.subtotal);

     // Si hay discrepancia, sobrescribir el valor
     if (Math.abs(subtotalDirecto - breakdown.subtotal) > 0.01) {
        console.warn("⚠️ Discrepancia detectada en el subtotal, usando valor calculado directamente");
        breakdown.subtotal = subtotalDirecto;
    }

    // Actualizar tabla de desglose financiero
    updateFinancialBreakdownTable(breakdown, simboloMoneda);
    
    // Generar tabla de desembolsos SOLO con datos del formulario
    generateDesembolsosTable(breakdown.finalAmount, simboloMoneda, fechaFormulario);
    
    // Si la empresa es Coopexpress, asegurarse de mostrar las filas específicas
    if (empresa === "Coopexpress") {
        toggleCoopexpressExpenses();
    }
    
    // Establecer que se ha calculado una cotización
    window.cotizacionCalculada = true;
    
}


function calculaSubtotal() {
    // Obtener el capital
    const capital = parseFloat(document.getElementById('capital').value) || 0;
    console.log("Capital leído:", capital);
    
    // Obtener todos los valores de gastos que aparecen en la tabla
    const interesesMesEl = document.getElementById('desglose-intereses-mes');
    const interesesAdelantadosEl = document.getElementById('desglose-intereses-adelantados');
    const corretajeEl = document.getElementById('desglose-corretaje');
    const gastosAdminEl = document.getElementById('desglose-gastos-admin');
    
    console.log("Texto intereses mes:", interesesMesEl?.textContent);
    console.log("Texto intereses adelantados:", interesesAdelantadosEl?.textContent);
    console.log("Texto corretaje:", corretajeEl?.textContent);
    console.log("Texto gastos admin:", gastosAdminEl?.textContent);
    
    // Función para extraer el valor numérico de un texto con formato
    const extraerValor = (texto) => {
        if (!texto) return 0;
        console.log("Extrayendo valor de:", texto);
        
        // Si el formato es (123.45), extraer el número y retornarlo como negativo
        if (texto.startsWith('(') && texto.endsWith(')')) {
            const valorExtraido = -parseFloat(texto.substring(1, texto.length - 1).replace(/,/g, ''));
            console.log("  → Valor extraído (paréntesis):", valorExtraido);
            return valorExtraido;
        }
        
        // Si es un número normal, convertirlo
        const valorExtraido = parseFloat(texto.replace(/,/g, ''));
        console.log("  → Valor extraído (normal):", valorExtraido);
        return valorExtraido;
    };
    
    // Obtener los valores numéricos
    const interesesMes = extraerValor(interesesMesEl?.textContent);
    const interesesAdelantados = extraerValor(interesesAdelantadosEl?.textContent);
    const corretaje = extraerValor(corretajeEl?.textContent);
    const gastosAdmin = extraerValor(gastosAdminEl?.textContent);
    
    // Valores adicionales de Coopexpress (solo si aplican)
    let courier = 0;
    let cooperative = 0;
    
    const empresa = document.getElementById('empresa').value;
    if (empresa === "Coopexpress") {
        const courierEl = document.getElementById('desglose-courier');
        const coopEl = document.getElementById('desglose-coop');
        courier = extraerValor(courierEl?.textContent);
        cooperative = extraerValor(coopEl?.textContent);
    }
    
    // Calcular el subtotal correctamente
    const subtotal = capital + interesesMes + interesesAdelantados + corretaje + gastosAdmin + courier + cooperative;
    
    console.log({
        capital,
        interesesMes,
        interesesAdelantados,
        corretaje,
        gastosAdmin,
        courier,
        cooperative,
        subtotal
    });
    
    return subtotal;
}


function updateFinancialBreakdownTable(breakdown, currency) {
    // Función para formatear valores negativos entre paréntesis
    const formatValue = (value) => {
        if (value < 0) {
            return `(${formatNumber(Math.abs(value))})`;
        }
        return formatNumber(value);
    };
    
    // Actualizar cada elemento en la tabla con los valores calculados
    const updateField = (id, value) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = formatValue(value);
        }
    };
    
    // Primero, eliminar cualquier fila de desglose que pudiera existir
    // para evitar duplicados al recalcular
    removeGastosRows();
    
    // Actualizar todos los campos con sus respectivos valores
    updateField('desglose-monto', breakdown.capital);
    updateField('desglose-intereses-mes', breakdown.currentMonthInterest);
    updateField('desglose-intereses-adelantados', breakdown.advanceInterest);
    updateField('desglose-corretaje', breakdown.brokerageFee);
    updateField('desglose-gastos-admin', breakdown.administrationFee);
    
    // Verificar si es Coopexpress y mostrar las filas correspondientes
    const empresa = document.getElementById('empresa').value;
    const isCoopexpress = empresa === "Coopexpress";
    
    // Courier
    const courierRow = document.getElementById('desglose-courier-row');
    if (!courierRow) {
        // Si no existe la fila, crearla
        createCoopexpressRows();
    }
    
    // Obtener las filas después de asegurarse de que existen
    const updatedCourierRow = document.getElementById('desglose-courier-row');
    const updatedCoopRow = document.getElementById('desglose-coop-row');
    
    // Mostrar u ocultar según corresponda
    if (updatedCourierRow) updatedCourierRow.style.display = isCoopexpress ? 'table-row' : 'none';
    if (updatedCoopRow) updatedCoopRow.style.display = isCoopexpress ? 'table-row' : 'none';
    
    // Actualizar valores específicos de Coopexpress
    if (isCoopexpress) {
        updateField('desglose-courier', -75);
        updateField('desglose-coop', -100);
    }
    
    // Actualizar subtotal y resto de campos
    updateField('desglose-subtotal', breakdown.subtotal);
    updateField('desglose-gastos-inscripcion', breakdown.registrationFees.total);
    updateField('desglose-honorarios', breakdown.registrationFees.honorarios);
    updateField('desglose-timbre', breakdown.registrationFees.timbreNotarial);
    updateField('desglose-registro', breakdown.registrationFees.registro);
    updateField('desglose-timbres', breakdown.registrationFees.timbresFiscales);
    updateField('desglose-otros-gastos-legales', breakdown.totalLegalExpenses);
    updateField('desglose-otros-gastos', breakdown.totalOtherExpenses);
    updateField('desglose-total-gastos', breakdown.totalExpenses);
    updateField('desglose-total-recibe', breakdown.finalAmount);
    
    // Agregar desglose detallado de gastos legales si existen
    if (breakdown.legalExpensesData && breakdown.legalExpensesData.items && breakdown.legalExpensesData.items.length > 0) {
        // Obtener la fila después de la cual insertaremos el desglose
        const rowOtrosGastosLegales = document.getElementById('desglose-otros-gastos-legales').closest('tr');
        
        if (rowOtrosGastosLegales) {
            // Insertar filas de desglose en orden inverso para mantener el orden correcto
            for (let i = breakdown.legalExpensesData.items.length - 1; i >= 0; i--) {
                const item = breakdown.legalExpensesData.items[i];
                const newRow = document.createElement('tr');
                newRow.className = 'text-red-600 gasto-detalle-row';
                newRow.innerHTML = `
                    <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>${item.nombre}</td>
                    <td class="py-1 px-3 text-right">(${formatNumber(item.costo)})</td>
                `;
                rowOtrosGastosLegales.insertAdjacentElement('afterend', newRow);
            }
        }
    }
    
    // Agregar desglose detallado de otros gastos si existen
    if (breakdown.otherExpensesData && breakdown.otherExpensesData.items && breakdown.otherExpensesData.items.length > 0) {
        // Obtener la fila después de la cual insertaremos el desglose
        const rowOtrosGastos = document.getElementById('desglose-otros-gastos').closest('tr');
        
        if (rowOtrosGastos) {
            // Insertar filas de desglose en orden inverso para mantener el orden correcto
            for (let i = breakdown.otherExpensesData.items.length - 1; i >= 0; i--) {
                const item = breakdown.otherExpensesData.items[i];
                const newRow = document.createElement('tr');
                newRow.className = 'text-red-600 gasto-detalle-row';
                newRow.innerHTML = `
                    <td class="py-1 px-3 pl-6"><span class="text-xs mr-1">(-)</span>${item.nombre}</td>
                    <td class="py-1 px-3 text-right">(${formatNumber(item.costo)})</td>
                `;
                rowOtrosGastos.insertAdjacentElement('afterend', newRow);
            }
        }
    }
}

// Función auxiliar para eliminar filas de gastos existentes
function removeGastosRows() {
    // Eliminar todas las filas de desglose de gastos
    const gastosRows = document.querySelectorAll('.gasto-detalle-row');
    gastosRows.forEach(row => row.remove());
}





function generateDesembolsosTable(totalAmount, currency, fechaSeleccionada) {
    const desembolsosContainer = document.getElementById('desembolsos-container');
    const desembolsosPrint = document.getElementById('desembolsos-print');
    
    if (!desembolsosPrint) return;
    
    // Limpiar tabla actual
    desembolsosPrint.innerHTML = '';
    
    // Formatear fecha para mostrar
    let fechaMostrar = fechaSeleccionada;
    if (fechaSeleccionada) {
        const partesFecha = fechaSeleccionada.split('-');
        if (partesFecha.length === 3) {
            fechaMostrar = `${partesFecha[2]}/${partesFecha[1]}/${partesFecha[0]}`;
        }
    } else {
        const hoy = new Date();
        fechaMostrar = `${hoy.getDate().toString().padStart(2, '0')}/${(hoy.getMonth() + 1).toString().padStart(2, '0')}/${hoy.getFullYear()}`;
    }
    
    // Variable para llevar el total de desembolsos
    let totalDesembolsos = 0;
    
    // Bandera para verificar si hay desembolsos válidos
    let hayDesembolsosValidos = false;
    
    // Verificar si hay filas en desembolsosContainer
    if (desembolsosContainer && desembolsosContainer.children) {
        // Procesar cada fila de desembolsos del formulario
        Array.from(desembolsosContainer.children).forEach((row, index) => {
            // Capturar datos de la fila
            const tipoDesembolso = row.querySelector('select:first-child')?.value || '';
            const beneficiario = row.querySelector('input[placeholder="Beneficiario"]')?.value || '';
            const montoInput = row.querySelector('input[type="number"]');
            const monto = montoInput ? parseFloat(montoInput.value) || 0 : 0;
            const conceptoSelect = row.querySelector('td:nth-child(4) select');
            const concepto = conceptoSelect ? conceptoSelect.value || '' : '';
            
            // Solo procesar filas con datos válidos
            if (beneficiario && monto > 0) {
                hayDesembolsosValidos = true;
                
                // Verificar empresa según fórmula Excel
                let empresaDesembolso = document.getElementById('empresa').value;
                if (tipoDesembolso === 'Compraventa') {
                    empresaDesembolso = 'Tecnolease';
                }
                
                const newRow = document.createElement('tr');
                newRow.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                // Incrementar total
                totalDesembolsos += monto;
                
                // Crear fila con los datos
                newRow.innerHTML = `
                    <td class="py-1 px-1 text-xs">${fechaMostrar}</td>
                    <td class="py-1 px-1 text-xs">${beneficiario}</td>
                    <td class="py-1 px-1 text-xs text-right">${formatNumber(monto)}</td>
                    <td class="py-1 px-1 text-xs">${tipoDesembolso}</td>
                    <td class="py-1 px-1 text-xs">${concepto}</td>
                    <td class="py-1 px-1 text-xs">Industrial</td>
                    <td class="py-1 px-1 text-xs">${empresaDesembolso}</td>
                `;
                
                desembolsosPrint.appendChild(newRow);
            }
        });
    }
    
    // Solo actualizar el total si hay desembolsos válidos
    if (hayDesembolsosValidos) {
        if (document.getElementById('total-desembolsos')) {
            document.getElementById('total-desembolsos').textContent = formatNumber(totalDesembolsos);
        }
    } else {
        // Si no hay desembolsos válidos, dejar el total vacío
        if (document.getElementById('total-desembolsos')) {
            document.getElementById('total-desembolsos').textContent = '';
        }
    }
}

function collectLegalExpenses() {
    console.log("Recopilando gastos legales del formulario...");
    
    // Obtener todos los gastos legales agregados por el usuario
    const gastosLegalesList = document.getElementById('lista-gastos-legales');
    let totalGastosLegales = 0;
    
    // Crear un array para almacenar los gastos individuales
    let gastosIndividuales = [];
    
    if (!gastosLegalesList) {
        console.log("No se encontró el elemento lista-gastos-legales");
        return { total: 0, items: [] };
    }
    
    // Verificar si hay elementos de gasto - si no hay, devolver 0
    const gastoItems = gastosLegalesList.querySelectorAll('.eliminar-gasto-visual');
    console.log(`Se encontraron ${gastoItems.length} elementos de gasto legal`);
    
    if (gastoItems.length === 0) {
        console.log("No hay elementos de gasto");
        return { total: 0, items: [] };
    }
    
    // Si hay mensajes "no hay gastos", significa que no hay gastos agregados
    const noGastosMsg = document.getElementById('no-gastos-legales');
    if (noGastosMsg && noGastosMsg.style.display !== 'none') {
        console.log("El mensaje 'no hay gastos' está visible");
        return { total: 0, items: [] };
    }
    
    // Recorrer todos los elementos que son gastos
    gastoItems.forEach((item, index) => {
        const gastoElement = item.closest('div.flex');
        if (gastoElement) {
            // Obtener el nombre del gasto (título)
            const nombreGasto = gastoElement.querySelector('.font-medium')?.textContent || '';
            
            // Obtener el texto completo que incluye el costo
            const gastoCostoText = gastoElement.querySelector('.text-sm')?.textContent || '';
            console.log(`Gasto #${index + 1}: "${nombreGasto}" - "${gastoCostoText}"`);
            
            // Extraer el número usando una expresión regular
            const matches = gastoCostoText.match(/Q\s*([\d,]+(\.\d+)?)/);
            if (matches && matches[1]) {
                // Convertir el texto a número
                const costo = parseFloat(matches[1].replace(/,/g, ''));
                console.log(`  → Valor extraído: ${costo}`);
                
                // Obtener cantidad si existe
                const cantidadMatch = gastoCostoText.match(/×\s*(\d+)/);
                const cantidad = cantidadMatch ? parseInt(cantidadMatch[1]) : 1;
                
                // Agregar al total y a la lista de items
                const costoTotal = costo * cantidad;
                totalGastosLegales += isNaN(costoTotal) ? 0 : costoTotal;
                
                // Agregar a la lista de gastos individuales
                gastosIndividuales.push({
                    nombre: nombreGasto,
                    costo: costoTotal  // Guardamos como positivo para procesarlo después
                });
            } else {
                console.log("  → No se pudo extraer el valor numérico");
            }
        }
    });
    
    console.log(`Total de gastos legales: ${totalGastosLegales}`);
    console.log(`Items individuales: ${JSON.stringify(gastosIndividuales)}`);
    
    return { 
        total: totalGastosLegales,
        items: gastosIndividuales
    };
}


function collectOtherExpenses() {
    console.log("Recopilando otros gastos del formulario...");
    
    const otrosGastosList = document.getElementById('lista-otros-gastos');
    let totalOtrosGastos = 0;
    let gastosIndividuales = [];
    
    if (!otrosGastosList) {
        console.log("No se encontró el elemento lista-otros-gastos");
        return { total: 0, items: [] };
    }
    
    // Verificar si hay elementos de gasto
    const gastoItems = otrosGastosList.querySelectorAll('.eliminar-otro-gasto');
    console.log(`Se encontraron ${gastoItems.length} elementos de otros gastos`);
    
    if (gastoItems.length === 0) {
        console.log("No hay elementos de otros gastos");
        return { total: 0, items: [] };
    }
    
    // Si hay mensajes "no hay gastos", devolver 0
    const noGastosMsg = document.getElementById('no-otros-gastos');
    if (noGastosMsg && noGastosMsg.style.display !== 'none') {
        console.log("El mensaje 'no hay otros gastos' está visible");
        return { total: 0, items: [] };
    }
    
    // Recorrer todos los elementos que son gastos
    gastoItems.forEach((item, index) => {
        const gastoElement = item.closest('div.flex');
        if (gastoElement) {
            // Obtener el nombre del gasto
            const nombreGasto = gastoElement.querySelector('.font-medium')?.textContent || '';
            
            // Obtener el costo almacenado
            const costInput = gastoElement.querySelector('.otro-gasto-cost');
            if (costInput) {
                const costo = parseFloat(costInput.value);
                console.log(`Otro gasto #${index + 1}: ${nombreGasto} = ${costo}`);
                
                totalOtrosGastos += isNaN(costo) ? 0 : costo;
                
                // Agregar a la lista de gastos individuales
                gastosIndividuales.push({
                    nombre: nombreGasto,
                    costo: costo  // Guardamos como positivo para procesarlo después
                });
            } else {
                console.log(`Otro gasto #${index + 1}: No se encontró el valor`);
            }
        }
    });
    
    console.log(`Total de otros gastos: ${totalOtrosGastos}`);
    return {
        total: totalOtrosGastos,
        items: gastosIndividuales
    };
}

// Función para formatear números
function formatNumber(number) {
    return number.toLocaleString('es-GT', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}


// Función para mostrar y ocultar elementos con animación
function toggleElement(element, show) {
    if (!element) return;
    
    if (show) {
        element.style.display = 'block';
        setTimeout(() => {
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, 10);
    } else {
        element.style.opacity = '0';
        element.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            element.style.display = 'none';
        }, 300);
    }
}

// Función para mostrar notificación de gasto agregado
function showNotification(message, isSuccess = true) {
    // Crear elemento de notificación si no existe
    let notification = document.getElementById('gasto-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'gasto-notification';
        notification.className = 'fixed top-4 right-4 py-2 px-4 rounded shadow-lg transform transition-all duration-300 z-50';
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        document.body.appendChild(notification);
    }
    
    // Configurar estilo y mensaje
    notification.className = isSuccess 
        ? 'fixed top-4 right-4 py-2 px-4 bg-green-500 text-white rounded shadow-lg transform transition-all duration-300 z-50'
        : 'fixed top-4 right-4 py-2 px-4 bg-red-500 text-white rounded shadow-lg transform transition-all duration-300 z-50';
    notification.textContent = message;
    
    // Mostrar y luego ocultar
    notification.style.opacity = '1';
    notification.style.transform = 'translateY(0)';
    
    // Ocultar después de 3 segundos
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
    }, 3000);
}

// Mejorar la interacción al agregar un gasto legal
document.getElementById('agregar-gasto-legal')?.addEventListener('click', function() {
    const selectGasto = document.getElementById('select-gasto-legal');
    if (selectGasto.value === "") {
        showNotification('Por favor seleccione un gasto legal', false);
        selectGasto.focus();
        return;
    }
    

    // Después de agregar el gasto exitosamente
    showNotification('Gasto legal agregado correctamente');
    
    // Ocultar el mensaje "no hay gastos"
    const noGastosMsg = document.getElementById('no-gastos-legales');
    if (noGastosMsg) {
        toggleElement(noGastosMsg, false);
    }
});

// Mejorar la interacción al agregar otro gasto
document.getElementById('agregar-otro-gasto')?.addEventListener('click', function() {
    const selectGasto = document.getElementById('select-otro-gasto');
    const costoInput = document.getElementById('otro-gasto-costo');
    
    if (selectGasto.value === "") {
        showNotification('Por favor seleccione un tipo de gasto', false);
        selectGasto.focus();
        return;
    }
    
    if (parseFloat(costoInput.value) <= 0) {
        showNotification('Por favor ingrese un costo válido', false);
        costoInput.focus();
        return;
    }
    
    // El resto del código existente para agregar el gasto
    // ...
    
    // Después de agregar el gasto exitosamente
    showNotification('Gasto adicional agregado correctamente');
    
    // Ocultar el mensaje "no hay gastos"
    const noGastosMsg = document.getElementById('no-otros-gastos');
    if (noGastosMsg) {
        toggleElement(noGastosMsg, false);
    }
});

// Ajustar la altura de los contenedores de gastos para que sean iguales
function equalizeHeight() {
    const listaGastosLegales = document.getElementById('lista-gastos-legales');
    const listaOtrosGastos = document.getElementById('lista-otros-gastos');
    
    if (listaGastosLegales && listaOtrosGastos && window.innerWidth >= 768) {
        // Restablecer alturas
        listaGastosLegales.style.height = 'auto';
        listaOtrosGastos.style.height = 'auto';
        
        // Obtener la altura máxima
        const height1 = listaGastosLegales.offsetHeight;
        const height2 = listaOtrosGastos.offsetHeight;
        const maxHeight = Math.max(height1, height2);
        
        // Aplicar altura máxima a ambos contenedores
        if (maxHeight > 150) {
            listaGastosLegales.style.height = `${maxHeight}px`;
            listaOtrosGastos.style.height = `${maxHeight}px`;
        }
    } else {
        // En dispositivos móviles, restablecer alturas
        if (listaGastosLegales) listaGastosLegales.style.height = 'auto';
        if (listaOtrosGastos) listaOtrosGastos.style.height = 'auto';
    }
}

// Ejecutar al cargar y cuando se redimensiona la ventana
window.addEventListener('load', equalizeHeight);
window.addEventListener('resize', equalizeHeight);

// Ejecutar cuando los gastos cambien
const observerConfig = { childList: true, subtree: true };
const observer = new MutationObserver(equalizeHeight);

// Observar cambios en los contenedores de gastos
const listaGastosLegales = document.getElementById('lista-gastos-legales');
const listaOtrosGastos = document.getElementById('lista-otros-gastos');

if (listaGastosLegales) observer.observe(listaGastosLegales, observerConfig);
if (listaOtrosGastos) observer.observe(listaOtrosGastos, observerConfig);

// Crear animaciones para las tarjetas de gastos
function setupGastoAnimations() {
    // Animación al eliminar un gasto
    document.addEventListener('click', function(e) {
        if (e.target.closest('.eliminar-gasto-visual') || e.target.closest('.eliminar-otro-gasto')) {
            const card = e.target.closest('.flex.justify-between');
            if (card) {
                // Aplicar animación de salida
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(20px)';
                
                // Esperar a que termine la animación antes de eliminar
                setTimeout(() => {
                    // Aquí el código original de eliminación...
                }, 300);
            }
        }
    });
}

// Iniciar las animaciones
setupGastoAnimations();

// Forzar misma altura en los contenedores de gastos
function forceEqualContainerHeights() {
  const container1 = document.getElementById('lista-gastos-legales');
  const container2 = document.getElementById('lista-otros-gastos');
  
  if (container1 && container2) {
    const maxHeight = Math.max(container1.scrollHeight, container2.scrollHeight);
    container1.style.height = maxHeight + 'px';
    container2.style.height = maxHeight + 'px';
  }
}

// Ejecutar cuando se carga la página y cuando cambia el tamaño de la ventana
window.addEventListener('load', forceEqualContainerHeights);
window.addEventListener('resize', forceEqualContainerHeights);


// Solución simplificada y completa para generar PDF con todos los detalles
(function() {
    // Esperar a que el DOM esté completamente cargado
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        inicializar();
    }
    
    // Función de inicialización
    function inicializar() {
        console.log("Inicializando generador de PDF simplificado...");
        
        // Reemplazar el botón PDF
        const pdfButton = document.getElementById('save-pdf-btn');
        if (pdfButton) {
            const newButton = pdfButton.cloneNode(true);
            pdfButton.parentNode.replaceChild(newButton, pdfButton);
            
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                generarPDF();
                return false;
            });
        }
    }
    
    // Función para generar el PDF
    function generarPDF() {
        // Mostrar indicador de carga
        const overlay = crearOverlayCarga();
        document.body.appendChild(overlay);
        
        // Asegurar que estamos en la pestaña de resumen
        const tabBotones = document.querySelectorAll('.tab-button');
        tabBotones.forEach(boton => {
            if (boton.dataset && boton.dataset.tab === 'summary' && !boton.classList.contains('active')) {
                boton.click();
            }
        });
        
        // Esperar a que se active la pestaña
        setTimeout(function() {
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                if (!printWindow) {
                    alert('Por favor permite las ventanas emergentes para imprimir el documento');
                    document.body.removeChild(overlay);
                    return;
                }
                
                // Obtener contenido para el PDF
                const contenidoHTML = generarContenidoHTML();
                
                // Escribir el contenido en la ventana
                printWindow.document.open();
                printWindow.document.write(contenidoHTML);
                printWindow.document.close();
                
                // Manejar evento de carga
                printWindow.onload = function() {
                    document.body.removeChild(overlay);
                    
                    // Imprimir automáticamente después de 1 segundo
                    setTimeout(function() {
                        printWindow.print();
                    }, 1000);
                };
            } catch (error) {
                console.error("Error al generar PDF:", error);
                document.body.removeChild(overlay);
                alert("Error al generar el PDF: " + error.message);
            }
        }, 500);
    }
    
// Función corregida para generar contenido HTML para PDF sin página extra en blanco
function generarContenidoHTML() {
    // Obtener datos básicos
    const empresa = document.getElementById('print-empresa')?.textContent || '';
    const cliente = document.getElementById('print-cliente')?.textContent || '';
    const dpi = document.getElementById('print-dpi')?.textContent || '';
    const nit = document.getElementById('print-nit')?.textContent || '';
    const tipoPrestamo = document.getElementById('print-tipo-prestamo')?.textContent || '';
    const interes = document.getElementById('print-interes')?.textContent || '';
    const interesMensual = document.getElementById('print-interes-mensual')?.textContent || '';
    const mesesAdelantados = document.getElementById('print-meses-adelantados')?.textContent || '';
    const corretaje = document.getElementById('print-corretaje')?.textContent || '';
    const gastosAdmin = document.getElementById('print-gastos-admin')?.textContent || '';
    const legal = document.getElementById('print-legal')?.textContent || '';
    
    // Fecha actual formateada
    const fechaActual = new Date();
    const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = fechaActual.toLocaleDateString('es-GT', opcionesFecha);
    
    // Obtener datos del desglose financiero
    const desgloseFinanciero = obtenerDesgloseFinanciero();
    
    // Obtener detalle de desembolsos
    const detalleDesembolsos = obtenerDetalleDesembolsos();
    
    // Obtener detalle de gastos
    const detalleGastos = obtenerDetalleGastos();
    
    // Obtener la diferencia ya calculada del elemento existente
    const diferenciaElement = document.getElementById('diferencia-cotizacion');
    const diferenciaTotal = diferenciaElement ? diferenciaElement.textContent : '0.00';
    const diferenciaClass = diferenciaElement && diferenciaElement.classList.contains('text-green-600') ? 'positive' : 'negative';
    
    // Construir el HTML completo con formato elegante y compacto
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Propuesta de Hipoteca - ${empresa}</title>
            <meta charset="UTF-8">
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
                
                /* Variables de diseño */
                :root {
                    --primary: #FF6B00;
                    --primary-dark: #E05600;
                    --primary-light: #FFF0E6;
                    --secondary: #003366;
                    --gray-dark: #333333;
                    --gray: #555555;
                    --gray-light: #777777;
                    --border: #DDDDDD;
                    --success: #28a745;
                    --danger: #dc3545;
                    --warning: #ffc107;
                    --info: #17a2b8;
                }
                
                /* Estilos generales */
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Poppins', Arial, sans-serif;
                    font-size: 9pt;
                    line-height: 1.3;
                    color: var(--gray-dark);
                    background: white;
                }
                
                .page {
                    width: 100%;
                    padding: 0.5in 0.5in 0.75in 0.5in;
                    position: relative;
                    background: white;
                    page-break-after: always;
                }
                
                /* Estilo de hoja membretada */
                .letterhead {
                    position: relative;
                    height: 90px;
                    margin-bottom: 15px;
                }
                
                .letterhead-bg {
                    position: absolute;
                    top: -0.5in;
                    left: -0.5in;
                    right: -0.5in;
                    height: 1.2in;
                    background: linear-gradient(135deg, var(--primary-dark), var(--primary));
                    clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
                    z-index: 0;
                }
                
                .letterhead-content {
                    position: relative;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    z-index: 1;
                    padding-top: 10px;
                }
                
                .company-logo {
                    font-size: 22pt;
                    font-weight: 700;
                    color: white;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    letter-spacing: -0.5px;
                }
                
                .company-slogan {
                    color: rgba(255,255,255,0.8);
                    font-size: 9pt;
                    font-weight: 300;
                    letter-spacing: 0.5px;
                }
                
                .document-badge {
                    background: white;
                    padding: 8px 20px;
                    border-radius: 20px;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                    display: inline-block;
                }
                
                .document-title {
                    color: var(--primary);
                    font-weight: 700;
                    font-size: 12pt;
                    margin-bottom: 2px;
                    text-align: center;
                }
                
                .document-date {
                    color: var(--gray-light);
                    font-size: 8pt;
                    text-align: center;
                }
                
                /* Estilo de contenido */
                .document-body {
                    position: relative;
                    z-index: 1;
                }
                
                .client-section {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 12px;
                    margin-bottom: 15px;
                    background: linear-gradient(to right, white, var(--primary-light));
                    padding: 10px;
                    border-radius: 5px;
                    border-left: 3px solid var(--primary);
                }
                
                .info-field {
                    margin-bottom: 0;
                }
                
                .info-label {
                    font-size: 7pt;
                    text-transform: uppercase;
                    color: var(--gray);
                    font-weight: 600;
                    margin-bottom: 2px;
                }
                
                .info-value {
                    font-size: 9pt;
                    font-weight: 500;
                }
                
                .span-2 {
                    grid-column: span 2;
                }
                
                .span-3 {
                    grid-column: span 3;
                }
                
                .content-grid {
                    display: grid;
                    grid-template-columns: 60% 40%;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .section-title {
                    font-size: 10pt;
                    font-weight: 600;
                    color: var(--secondary);
                    margin-bottom: 8px;
                    padding-bottom: 4px;
                    border-bottom: 1px solid var(--border);
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 10px;
                    font-size: 8pt;
                }
                
                th {
                    background-color: var(--primary);
                    color: white;
                    text-align: left;
                    padding: 5px 6px;
                    font-weight: 600;
                    font-size: 7.5pt;
                }
                
                td {
                    padding: 4px 6px;
                    border-bottom: 1px solid var(--border);
                }
                
                tr:nth-child(even) {
                    background-color: rgba(0,0,0,0.02);
                }
                
                .text-right {
                    text-align: right;
                }
                
                .subtotal-row {
                    background-color: #f8f8f8;
                    font-weight: 600;
                }
                
                .total-row {
                    background-color: var(--primary-light);
                    font-weight: 700;
                    color: var(--primary-dark);
                    font-size: 9pt;
                }
                
                /* Sección de diferencia */
                .diferencia-box {
                    background-color: rgba(255, 193, 7, 0.15);
                    border: 1px solid var(--warning);
                    border-radius: 4px;
                    padding: 8px 10px;
                    margin-top: 5px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .diferencia-label {
                    font-weight: 600;
                    font-size: 8pt;
                    color: var(--gray-dark);
                }
                
                .diferencia-value {
                    font-weight: 700;
                    font-size: 10pt;
                }
                
                .positive {
                    color: var(--success);
                }
                
                .negative {
                    color: var(--danger);
                }
                
                .diferencia-note {
                    font-size: 7pt;
                    color: var(--gray-light);
                    font-style: italic;
                }
                
                /* Firmas */
                .signatures {
                    display: flex;
                    justify-content: space-between;
                    margin-top: 25px;
                }
                
                .signature {
                    width: 140px;
                    text-align: center;
                }
                
                .signature-line {
                    border-top: 1px solid var(--gray-dark);
                    margin-bottom: 4px;
                }
                
                .signature-name {
                    font-size: 9pt;
                    font-weight: 600;
                }
                
                .signature-title {
                    font-size: 8pt;
                    color: var(--gray-light);
                }
                
                /* Pie de página */
                .footer {
                    position: absolute;
                    bottom: 0.5in;
                    left: 0.5in;
                    right: 0.5in;
                    text-align: center;
                    font-size: 7pt;
                    color: var(--gray-light);
                    padding-top: 5px;
                    border-top: 1px solid var(--border);
                }
                
                .contact-info {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                    margin-top: 3px;
                }
                
                /* Página de detalles de gastos */
                .page-title {
                    background-color: var(--secondary);
                    color: white;
                    padding: 10px 15px;
                    font-size: 14pt;
                    font-weight: 700;
                    text-align: center;
                    margin: 15px 0;
                    border-radius: 5px;
                }
                
                /* Botones de impresión */
                .print-buttons {
                    text-align: center;
                    margin: 15px 0;
                    padding: 15px;
                    background-color: #f5f5f5;
                    border-radius: 5px;
                }
                
                .btn {
                    background-color: var(--primary);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    font-size: 11pt;
                    font-weight: 600;
                    border-radius: 4px;
                    cursor: pointer;
                    margin: 0 5px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    transition: all 0.2s ease;
                }
                
                .btn:hover {
                    background-color: var(--primary-dark);
                    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
                }
                
                .btn-secondary {
                    background-color: #666;
                }
                
                .btn-secondary:hover {
                    background-color: #555;
                }
                
                @media print {
                    body {
                        margin: 0;
                        padding: 0;
                    }
                    
                    .page {
                        margin: 0;
                        box-shadow: none;
                        page-break-after: always;
                    }
                    
                    .page:last-of-type {
                        page-break-after: avoid;
                    }
                    
                    .print-buttons {
                        display: none;
                    }
                }
                    

/* Añadir estos estilos dentro del bloque <style> de generarContenidoHTML() */

/* Ajustes mejorados para impresión */
@media print {
    body {
        margin: 0;
        padding: 0;
    }
    
    .page {
        margin: 0;
        box-shadow: none;
        page-break-after: always;
    }
    
    .page:last-of-type {
        page-break-after: avoid;
    }
    
    .print-buttons {
        display: none;
    }
    
    /* Optimizaciones específicas para tablas */
    table {
        page-break-inside: avoid;
        width: 100% !important;
    }
    
    /* Reducir tamaño de fuente general para tablas en impresión */
    table th, table td {
        font-size: 8pt !important;
        padding: 3px 4px !important;
    }
    
    /* Contenido no debe exceder su celda */
    td {
        word-break: break-word;
        max-width: 100%;
    }
}

/* Mejorar visualización de tablas en general */
table {
    table-layout: fixed;
    width: 100%;
}

td {
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Asegurar que la tabla de desembolsos sea visible horizontalmente */
.content-grid {
    display: block;
    width: 100%;
}

.section-title {
    margin-top: 10px;
}



            </style>
        </head>
        <body>
            <!-- Primera Página - Resumen -->
            <div class="page">
                <!-- Encabezado tipo membrete -->
                <div class="letterhead">
                    <div class="letterhead-bg"></div>
                    <div class="letterhead-content">
                        <div>
                            <div class="company-logo">${empresa}</div>
                           
                        </div>
                        
                        <div class="document-badge">
                            <div class="document-title">PROPUESTA DE HIPOTECA</div>
                            <div class="document-date">${fechaFormateada}</div>
                        </div>
                    </div>
                </div>
                
                <div class="document-body">
                    <!-- Información del cliente -->
                    <div class="client-section">
                        <div class="info-field">
                            <div class="info-label">Cliente</div>
                            <div class="info-value">${cliente}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">DPI</div>
                            <div class="info-value">${dpi}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">NIT</div>
                            <div class="info-value">${nit}</div>
                        </div>
                        
                        <div class="info-field span-3">
                            <div class="info-label">Tipo de Préstamo</div>
                            <div class="info-value">${tipoPrestamo}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">% Interés</div>
                            <div class="info-value">${interes}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">Interés Mensual</div>
                            <div class="info-value">${interesMensual}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">Meses Adelantados</div>
                            <div class="info-value">${mesesAdelantados}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">% Corretaje</div>
                            <div class="info-value">${corretaje}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">% Gasto Admón.</div>
                            <div class="info-value">${gastosAdmin}</div>
                        </div>
                        
                        <div class="info-field">
                            <div class="info-label">% Legal</div>
                            <div class="info-value">${legal}</div>
                        </div>
                    </div>
                    
                    <!-- Tablas principales -->
                    <div class="content-grid">
                        <!-- Desglose financiero -->
                        <div>
                            <div class="section-title">Desglose Financiero</div>
                            ${desgloseFinanciero}
                        </div>
                        
                        <!-- Desembolsos -->
                        <div>
                            <div class="section-title">Detalle de Desembolsos</div>
                            ${detalleDesembolsos}
                            
                            <div class="diferencia-box">
                                <div class="diferencia-label">Diferencia contra cotización:</div>
                                <div>
                                    <div class="diferencia-value ${diferenciaClass}">${diferenciaTotal}</div>
                                    <div class="diferencia-note">(Diferencia debe ser 0)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Firmas -->
                    <br>
                    <br>
                    <br>
                    <br>
                    <div class="signatures">
                        <div class="signature">
                            <div class="signature-line"></div>
                            
                            <div class="signature-title">Elaboró</div>
                        </div>
                        
                        <div class="signature">
                            <div class="signature-line"></div>
                           
                            <div class="signature-title">Revisó</div>
                        </div>
                        
                    </div>
                </div>
                
             

            </div>
            
            <!-- Segunda Página - Detalle de Gastos (última página) -->
            <div class="page" style="page-break-after: avoid;">
                <!-- Encabezado tipo membrete -->
                <div class="letterhead">
                    <div class="letterhead-bg"></div>
                    <div class="letterhead-content">
                        <div>
                            <div class="company-logo">${empresa}</div>
                            
                        </div>
                        
                        <div class="document-badge">
                            <div class="document-title">PROPUESTA DE HIPOTECA</div>
                            <div class="document-date">${fechaFormateada}</div>
                        </div>
                    </div>
                </div>
                
                <div class="document-body">
                    <div class="page-title">DETALLE DE GASTOS</div>
                    
                    ${detalleGastos}
                </div>
                
                
              
            </div>
            
            <!-- Botones de impresión -->
            <div class="print-buttons">
                <button class="btn" onclick="window.print();">Imprimir / Guardar como PDF</button>
                <button class="btn btn-secondary" onclick="window.close();">Cerrar</button>
            </div>
        </body>
        </html>
    `;
}


    // Obtener HTML para el desglose financiero
    function obtenerDesgloseFinanciero() {
        // Obtener elementos del desglose desde el DOM
        const montoSolicitado = document.getElementById('desglose-monto')?.textContent || '';
        const interesesMes = document.getElementById('desglose-intereses-mes')?.textContent || '';
        const interesesAdelantados = document.getElementById('desglose-intereses-adelantados')?.textContent || '';
        const corretaje = document.getElementById('desglose-corretaje')?.textContent || '';
        const gastosAdmin = document.getElementById('desglose-gastos-admin')?.textContent || '';
        const subtotal = document.getElementById('desglose-subtotal')?.textContent || '';
        const gastosInscripcion = document.getElementById('desglose-gastos-inscripcion')?.textContent || '';
        const honorarios = document.getElementById('desglose-honorarios')?.textContent || '';
        const timbre = document.getElementById('desglose-timbre')?.textContent || '';
        const registro = document.getElementById('desglose-registro')?.textContent || '';
        const timbres = document.getElementById('desglose-timbres')?.textContent || '';
        const otrosGastosLegales = document.getElementById('desglose-otros-gastos-legales')?.textContent || '';
        const otrosGastos = document.getElementById('desglose-otros-gastos')?.textContent || '';
        const totalGastos = document.getElementById('desglose-total-gastos')?.textContent || '';
        const totalRecibe = document.getElementById('desglose-total-recibe')?.textContent || '';
        
        // Buscar filas de gastos específicos
        let filasGastosLegales = '';
        document.querySelectorAll('.gasto-detalle-row').forEach(fila => {
            const nombre = fila.querySelector('td:first-child')?.textContent || '';
            const valor = fila.querySelector('td:last-child')?.textContent || '';
            
            filasGastosLegales += `
                <tr>
                    <td>${nombre}</td>
                    <td class="amount">${valor}</td>
                </tr>
            `;
        });
        
        // Verificar si hay filas en Coopexpress
        let filasCoopexpress = '';
        const courierRow = document.getElementById('desglose-courier-row');
        const coopRow = document.getElementById('desglose-coop-row');
        
        if (courierRow && courierRow.style.display !== 'none') {
            const courierValue = document.getElementById('desglose-courier')?.textContent || '';
            filasCoopexpress += `
                <tr>
                    <td>(-) Courier - Documentación</td>
                    <td class="amount">${courierValue}</td>
                </tr>
            `;
        }
        
        if (coopRow && coopRow.style.display !== 'none') {
            const coopValue = document.getElementById('desglose-coop')?.textContent || '';
            filasCoopexpress += `
                <tr>
                    <td>(-) Cuota Cooperativa</td>
                    <td class="amount">${coopValue}</td>
                </tr>
            `;
        }
        
        // Construir tabla de desglose
        return `
            <table>
                <tr>
                    <td>Monto Solicitado</td>
                    <td class="amount">${montoSolicitado}</td>
                </tr>
                <tr>
                    <td>(-) Intereses del Mes en Curso</td>
                    <td class="amount">${interesesMes}</td>
                </tr>
                <tr>
                    <td>(-) Intereses Adelantados</td>
                    <td class="amount">${interesesAdelantados}</td>
                </tr>
                <tr>
                    <td>(-) Corretaje</td>
                    <td class="amount">${corretaje}</td>
                </tr>
                <tr>
                    <td>(-) Gastos Administrativos</td>
                    <td class="amount">${gastosAdmin}</td>
                </tr>
                ${filasCoopexpress}
                <tr class="subtotal">
                    <td>Sub Total</td>
                    <td class="amount">${subtotal}</td>
                </tr>
                <tr>
                    <td>Gastos de Inscripción de Hipoteca</td>
                    <td class="amount">${gastosInscripcion}</td>
                </tr>
                <tr>
                    <td>(-) Honorarios escrituración</td>
                    <td class="amount">${honorarios}</td>
                </tr>
                <tr>
                    <td>(-) Timbre Notarial</td>
                    <td class="amount">${timbre}</td>
                </tr>
                <tr>
                    <td>(-) Registro</td>
                    <td class="amount">${registro}</td>
                </tr>
                <tr>
                    <td>(-) Timbres Fiscales</td>
                    <td class="amount">${timbres}</td>
                </tr>
                <tr>
                    <td>Otros Gastos Legales</td>
                    <td class="amount">${otrosGastosLegales}</td>
                </tr>
                ${filasGastosLegales}
                <tr>
                    <td>Otros gastos</td>
                    <td class="amount">${otrosGastos}</td>
                </tr>
                <tr>
                    <td>Total Gastos</td>
                    <td class="amount">${totalGastos}</td>
                </tr>
                <tr class="total">
                    <td>Recibe de la Hipoteca</td>
                    <td class="amount">${totalRecibe}</td>
                </tr>
            </table>
        `;
    }
    
  // Aplicar estilos globales para las tablas de desembolsos
const estiloTablas = document.createElement('style');
estiloTablas.textContent = `
    /* Asegurar que todos los encabezados de tabla tengan texto blanco */
    table th {
        color: white !important;
        font-weight: bold !important;
    }
`;
document.head.appendChild(estiloTablas);

// Función mejorada para encabezados de tabla visibles con layout optimizado para impresión
function obtenerDetalleDesembolsos() {
    // Buscar la tabla de desembolsos en la vista de impresión
    const desembolsosPrint = document.getElementById('desembolsos-print');
    const totalDesembolsos = document.getElementById('total-desembolsos')?.textContent || '';
    
    // Definir estilo específico para la tabla de desembolsos
    const estiloTablaDesembolsos = `
        <style>
            /* Ajustes específicos para la tabla de desembolsos */
.tabla-desembolsos {
    width: 100%;
    font-size: 6pt !important; /* Reducir de 7.5pt a 6.5pt */
    table-layout: fixed;
    page-break-inside: avoid;
}
            
            .tabla-desembolsos th {
                color: white !important;
                font-weight: bold !important;
                 padding: 2px !important; /* Reducir de 4px a 2px */
                font-size: 6pt !important; /* Reducir de 7pt a 6pt */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .tabla-desembolsos td {
                padding: 2px !important; /* Reducir de 3px a 2px */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Definir anchos de columna específicos */
.tabla-desembolsos .col-fecha { width: 8%; }
.tabla-desembolsos .col-beneficiario { width: 15%; }
.tabla-desembolsos .col-monto { width: 10%; }
.tabla-desembolsos .col-desembolso { width: 10%; }
.tabla-desembolsos .col-concepto { width: 20%; }
.tabla-desembolsos .col-banco { width: 15%; }
.tabla-desembolsos .col-empresa { width: 12%; }
            
            @media print {
                .tabla-desembolsos {
                    font-size: 7pt !important;
                    table-layout: fixed;
                    width: 100% !important;
                }
                
                /* Forzar orientación horizontal solo para la página con esta tabla */
                
            }
        </style>
    `;
    
    // Si no hay elementos de desembolso, mostrar tabla vacía
    if (!desembolsosPrint || desembolsosPrint.children.length === 0) {
        return `
            ${estiloTablaDesembolsos}
            <table class="tabla-desembolsos">
                <thead style="background-color: #FF6B00;">
                    <tr>
                        <th class="col-fecha">Fecha</th>
                        <th class="col-beneficiario">Beneficiario</th>
                        <th class="col-monto">Monto</th>
                        <th class="col-desembolso">Desembolso</th>
                        <th class="col-concepto">Concepto</th>
                        <th class="col-banco">Banco</th>
                        <th class="col-empresa">Empresa</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center;">No hay desembolsos registrados</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" style="text-align: right; font-weight: bold;">Total</td>
                        <td class="amount">${totalDesembolsos}</td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
            </table>
        `;
    }
    
    // Construir tabla con desembolsos existentes
    let filasDesembolsos = '';
    Array.from(desembolsosPrint.children).forEach(fila => {
        // Cada fila debe mantener las clases de columna para mantener la estructura
        const celdas = Array.from(fila.cells);
        
        // Crear nueva fila con clases específicas para cada celda
        let nuevaFila = '<tr>';
        
        // Fecha
        nuevaFila += `<td class="col-fecha">${celdas[0]?.textContent || ''}</td>`;
        // Beneficiario
        nuevaFila += `<td class="col-beneficiario">${celdas[1]?.textContent || ''}</td>`;
        // Monto
        nuevaFila += `<td class="col-monto">${celdas[2]?.textContent || ''}</td>`;
        // Desembolso
        nuevaFila += `<td class="col-desembolso">${celdas[3]?.textContent || ''}</td>`;
        // Concepto
        nuevaFila += `<td class="col-concepto">${celdas[4]?.textContent || ''}</td>`;
        // Banco
        nuevaFila += `<td class="col-banco">${celdas[5]?.textContent || ''}</td>`;
        // Empresa
        nuevaFila += `<td class="col-empresa">${celdas[6]?.textContent || ''}</td>`;
        
        nuevaFila += '</tr>';
        filasDesembolsos += nuevaFila;
    });
    
    return `
        ${estiloTablaDesembolsos}
        <table class="tabla-desembolsos">
            <thead style="background-color: #FF6B00;">
                <tr>
                    <th class="col-fecha">Fecha</th>
                    <th class="col-beneficiario">Beneficiario</th>
                    <th class="col-monto">Monto</th>
                    <th class="col-desembolso">Desembolso</th>
                    <th class="col-concepto">Concepto</th>
                    <th class="col-banco">Banco</th>
                    <th class="col-empresa">Empresa</th>
                </tr>
            </thead>
            <tbody>
                ${filasDesembolsos}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" style="text-align: right; font-weight: bold;">Total</td>
                    <td class="amount">${totalDesembolsos}</td>
                    <td colspan="4"></td>
                </tr>
            </tfoot>
        </table>
    `;
}
    
    // Obtener HTML para el detalle de gastos
    function obtenerDetalleGastos() {
        // Buscar tabla en la pestaña de información
        let gastos = obtenerGastosLegales();
        let valorReembolso = obtenerValorReembolsar();
        
        return `
            <table>
                <thead>
                    <tr>
                        <th>NO.</th>
                        <th>TIPO DE GASTO</th>
                        <th>CANTIDAD</th>
                        <th>HONORARIOS</th>
                        <th>REEMBOLSO</th>
                        <th>RETENIDO</th>
                        <th>REEMBOLSO CTP</th>
                        <th>TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    ${gastos}
                </tbody>
            </table>
            
            <div class="reembolso">
                Valor a Reembolsar a Legal <span class="reembolso-valor">${valorReembolso}</span>
            </div>
        `;
    }
    
    // Obtener lista de gastos legales
    function obtenerGastosLegales() {
        // Primero intentar obtener de la tabla de la pestaña de información
        const infoGastosTable = document.getElementById('gastos-legales-table');
        if (infoGastosTable && infoGastosTable.children.length > 0) {
            let filas = '';
            Array.from(infoGastosTable.children).forEach(fila => {
                // Eliminar el botón de eliminar si existe
                const filaClone = fila.cloneNode(true);
                const btnEliminar = filaClone.querySelector('.eliminar-gasto');
                if (btnEliminar) {
                    btnEliminar.remove();
                }
                filas += filaClone.outerHTML;
            });
            return filas;
        }
        
        // Si no está disponible, crear desde los gastos del panel visual
        const gastosLegales = document.querySelectorAll('#lista-gastos-legales > div:not(#no-gastos-legales)');
        
        if (!gastosLegales || gastosLegales.length === 0) {
            return `
                <tr>
                    <td colspan="8" style="text-align: center; font-style: italic;">No hay gastos legales seleccionados</td>
                </tr>
            `;
        }
        
        let filas = '';
        let totalHonorarios = 0;
        let totalReembolso = 0;
        let totalRetenido = 0;
        let totalReemborsoCTP = 0;
        let granTotal = 0;
        
        gastosLegales.forEach((gasto, index) => {
            const nombreGasto = gasto.querySelector('.font-medium')?.textContent || 'Gasto legal';
            const detallesTexto = gasto.querySelector('.text-sm')?.textContent || '';
            
            // Extraer datos usando expresiones regulares
            const cantidadMatch = detallesTexto.match(/Cantidad: (\d+)/);
            const honorariosMatch = detallesTexto.match(/Honorarios: Q([0-9,.]+)/);
            const reembolsoMatch = detallesTexto.match(/Reembolso: Q([0-9,.]+)/);
            const retenidoMatch = detallesTexto.match(/Retenido: Q([0-9,.]+)/);
            
            const cantidad = cantidadMatch ? parseInt(cantidadMatch[1]) : 1;
            const honorarios = honorariosMatch ? parseFloat(honorariosMatch[1].replace(',', '')) : 0;
            const reembolso = reembolsoMatch ? parseFloat(reembolsoMatch[1].replace(',', '')) : 0;
            const retenido = retenidoMatch ? parseFloat(retenidoMatch[1].replace(',', '')) : 0;
            const reemborsoCTP = 0; // Valor por defecto
            
            // Total del gasto
            const total = honorarios + reembolso + retenido + reemborsoCTP;
            
            // Actualizar totales
            totalHonorarios += honorarios;
            totalReembolso += reembolso;
            totalRetenido += retenido;
            totalReemborsoCTP += reemborsoCTP;
            granTotal += total;
            
            // Formatear los valores para mostrar
            const honorariosStr = honorarios > 0 ? honorarios.toFixed(2) : '-';
            const reembolsoStr = reembolso > 0 ? reembolso.toFixed(2) : '-';
            const retenidoStr = retenido > 0 ? retenido.toFixed(2) : '-';
            const reemborsoCTPStr = reemborsoCTP > 0 ? reemborsoCTP.toFixed(2) : '-';
            
            filas += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${nombreGasto}</td>
                    <td>${cantidad}</td>
                    <td>${honorariosStr}</td>
                    <td>${reembolsoStr}</td>
                    <td>${retenidoStr}</td>
                    <td>${reemborsoCTPStr}</td>
                    <td>${total.toFixed(2)}</td>
                </tr>
            `;
        });
        
        // Añadir fila de totales
        filas += `
            <tr style="font-weight: bold; background-color: #f5f5f5;">
                <td colspan="3">Totales</td>
                <td>${totalHonorarios.toFixed(2)}</td>
                <td>${totalReembolso.toFixed(2)}</td>
                <td>${totalRetenido.toFixed(2)}</td>
                <td>${totalReemborsoCTP.toFixed(2)}</td>
                <td>${granTotal.toFixed(2)}</td>
            </tr>
        `;
        
        return filas;
    }
    
    // Obtener valor a reembolsar
    function obtenerValorReembolsar() {
        const valorElement = document.getElementById('valor-reembolsar-legal');
        if (valorElement) {
            return valorElement.textContent;
        }
        
        // Si no se encuentra, calcular de los gastos legales
        const gastosLegales = document.querySelectorAll('#lista-gastos-legales > div:not(#no-gastos-legales)');
        let totalReembolso = 0;
        
        gastosLegales.forEach(gasto => {
            const detallesTexto = gasto.querySelector('.text-sm')?.textContent || '';
            const reembolsoMatch = detallesTexto.match(/Reembolso: Q([0-9,.]+)/);
            
            if (reembolsoMatch) {
                totalReembolso += parseFloat(reembolsoMatch[1].replace(',', ''));
            }
        });
        
        return totalReembolso.toFixed(2);
    }
    
    // Crear overlay de carga
    function crearOverlayCarga() {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '99999';
        
        const spinnerContainer = document.createElement('div');
        spinnerContainer.style.backgroundColor = 'white';
        spinnerContainer.style.padding = '30px';
        spinnerContainer.style.borderRadius = '10px';
        spinnerContainer.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
        spinnerContainer.style.display = 'flex';
        spinnerContainer.style.flexDirection = 'column';
        spinnerContainer.style.alignItems = 'center';
        
        const spinner = document.createElement('div');
        spinner.style.border = '5px solid #f3f3f3';
        spinner.style.borderTop = '5px solid #FF6B00';
        spinner.style.borderRadius = '50%';
        spinner.style.width = '50px';
        spinner.style.height = '50px';
        spinner.style.animation = 'spin 1s linear infinite';
        
        const mensaje = document.createElement('div');
        mensaje.textContent = 'Generando PDF...';
        mensaje.style.marginTop = '15px';
        mensaje.style.fontWeight = 'bold';
        mensaje.style.color = '#333';
        
        // Crear animación
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
        
        spinnerContainer.appendChild(spinner);
        spinnerContainer.appendChild(mensaje);
        overlay.appendChild(spinnerContainer);
        
        return overlay;
    }
})();

function activarTablaDesembolsos() {
        // 1. Primero cambiar a la pestaña de formulario
        const formTab = document.querySelector('.tab-button[data-tab="form"]');
        if (formTab) {
            formTab.click();
        }
        
        // 2. Asegurar que todos los pasos previos estén marcados como completados
        const progressSteps = document.querySelectorAll('.progress-step');
        progressSteps.forEach((step, index) => {
            if (index < 4) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        // 3. Ocultar todos los pasos del formulario
        const formSteps = document.querySelectorAll('.form-step');
        formSteps.forEach(step => {
            step.classList.remove('active');
        });
        
        // 4. Mostrar específicamente el paso 4 (índice 3)
        if (formSteps.length > 3) {
            formSteps[3].classList.add('active');
        }
        
        // 5. Hacer scroll al contenedor de desembolsos
        const desembolsosContainer = document.getElementById('desembolsos-container');
        if (desembolsosContainer) {
            setTimeout(() => {
                desembolsosContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // Al finalizar la carga del documento, conecta el botón con la función
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar el botón de desembolsos
        const desembolsosBtn = document.getElementById('desembolsos-btn');
        if (desembolsosBtn) {
            // Aplicar estilos al botón
            desembolsosBtn.style.backgroundColor = '#FF6B00';
            desembolsosBtn.style.color = 'white';
            
            // Agregar evento de clic
            desembolsosBtn.addEventListener('click', function(e) {
                e.preventDefault();
                activarTablaDesembolsos();
            });
        }
    });

</script>


</body>
</html>
